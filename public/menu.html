<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú - Dulces Amigas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5; 
            --accent-color: #FF85A2;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-color-dark: #1e293b;
            --text-color-light: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        body.dark-mode {
            --background-color: #1e293b;
            --card-background: #334155;
            --text-color-dark: #f1f5f9;
            --text-color-light: #94a3b8;
            --border-color: #475569;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color-dark); 
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 2rem; position: relative; }
        
        /* == MEJORA ANTI-FLICKER: ESTILOS PARA EL LOGO == */
        #menu-logo {
            max-width: 200px;
            max-height: 80px;
            min-height: 80px; /* Reserva el espacio vertical para evitar saltos */
            opacity: 0; /* Empieza oculto */
            transition: opacity 0.5s ease-in-out; /* Animación de fundido */
        }
        #menu-logo.loaded {
            opacity: 1; /* Se revela cuando está cargado */
        }

        .card { 
            background-color: var(--card-background); 
            border-radius: 12px; 
            padding: 1.5rem; 
            margin-bottom: 2rem; 
            box-shadow: var(--shadow);
            transition: background-color 0.3s;
        }
        h2 { font-size: 1.5rem; color: var(--accent-color); margin-bottom: 1rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem;}
        h4 { margin-top: 1.5rem; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .menu-item { 
            border: 2px solid var(--border-color);
            border-radius: 8px; 
            padding: 1rem; 
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s, background-color 0.2s; 
            position: relative; 
        }
        .menu-item:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--shadow);
            border-color: var(--accent-color);
        }
        .menu-item.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }
        .menu-item.selected p { color: #e0e7ff; }
        .menu-item.agotado { background-color: #f1f5f9; color: #9ca3af; cursor: not-allowed; opacity: 0.6; }
        .menu-item.agotado:hover { transform: none; box-shadow: none; border-color: var(--border-color); }
        .agotado-badge { position: absolute; top: 8px; right: 8px; background-color: #ef4444; color: white; padding: 0.2em 0.5em; border-radius: 12px; font-size: 0.7em; font-weight: 600; }
        .menu-item h4 { margin-bottom: 0.5rem; font-size: 1.1rem; }
        .menu-item p { color: var(--text-color-light); }
        
        .add-to-cart-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--background-color);
            border-radius: 8px;
        }
        .add-to-cart-section span { font-size: 1.1rem; font-weight: 600; }
        #add-to-cart-btn { 
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color); 
            color: white; 
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        #add-to-cart-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }

        .cart h3 { font-size: 1.25rem; }
        #cart-items { list-style: none; padding: 0; margin-bottom: 1rem; }
        .cart-item { padding: 1rem 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: flex-start; }
        .cart-item-details { flex-grow: 1; }
        .cart-item-details strong { color: var(--text-color-dark); }
        .cart-item-details ul { list-style: none; padding-left: 1rem; margin-top: 0.5rem; }
        .cart-item-details li { color: var(--text-color-light); font-size: 0.9em; }
        .cart-item-actions { display: flex; flex-direction: column; align-items: flex-end; }
        .cart-item-actions .price { font-weight: 600; margin-bottom: 0.5rem; }
        .cart-item-actions button { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 0.9em; }
        
        #cart-total { text-align: right; font-weight: 700; font-size: 1.2rem; color: var(--primary-color); margin-bottom: 1.5rem; }
        
        form label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        form input { display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; background-color: var(--card-background); color: var(--text-color-dark); }
        form button { width: 100%; padding: 0.75rem; border-radius: 8px; border: none; background-color: var(--accent-color); color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        form button:hover { background-color: #f76c8c; }
        form button:disabled { background-color: #9ca3af; }

        .theme-switch-wrapper { position: absolute; top: 0; right: 0; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 26px; }
        .slider:before { background-color: #fff; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; position: absolute; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider .sun, .slider .moon { position: absolute; top: 50%; transform: translateY(-50%); }
        .slider .sun { left: 6px; opacity: 1; transition: opacity 0.2s; }
        .slider .moon { right: 6px; opacity: 0; transition: opacity 0.2s; }
        input:checked + .slider .sun { opacity: 0; }
        input:checked + .slider .moon { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle" />
                    <div class="slider">
                        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="yellow" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>
                    </div>
                </label>
            </div>
            <!-- == MEJORA ANTI-FLICKER: SRC CAMBIADO A UN PIXEL TRANSPARENTE == -->
            <img id="menu-logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Logo del Negocio">
            <h1>Nuestro Menú</h1>
            <p style="color: var(--text-color-light);">Arma tus productos uno por uno y añádelos a tu pedido.</p>
        </div>

        <div class="card">
            <h2>1. Elige un Producto Principal</h2>
            <div id="productos-container" class="menu-grid"></div>

            <h2 style="margin-top: 2rem;">2. Personalízalo con Extras</h2>
            <h4>Toppings</h4>
            <div id="toppings-container" class="menu-grid" style="margin-top: 1rem;"></div>
            <h4 style="margin-top: 1.5rem;">Jarabes</h4>
            <div id="jarabes-container" class="menu-grid" style="margin-top: 1rem;"></div>

            <div class="add-to-cart-section">
                <span id="current-item-total">Subtotal Producto: $0.00</span>
                <button id="add-to-cart-btn" disabled>Agregar al Pedido</button>
            </div>
        </div>
        
        <div class="card cart">
            <h3>Tu Pedido</h3>
            <div id="cart-items">
                <p style="color: var(--text-color-light);">Aún no has agregado productos a tu pedido.</p>
            </div>
            <p id="cart-total">Total del Pedido: $0.00</p>
            
            <form id="order-form">
                <h3 style="margin-top: 2rem;">Tus Datos</h3>
                <label for="nombreCliente">Tu Nombre:</label>
                <input type="text" id="nombreCliente" required>
                <label for="telefonoCliente">Tu Teléfono (WhatsApp):</label>
                <input type="tel" id="telefonoCliente" required>
                <button type="submit" id="submit-order-btn">Realizar Pedido</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let seleccionActual = { producto: null, toppings: [], jarabes: [] };
            let carrito = [];
            let productos = [], toppings = [], jarabes = [];

            const productosContainer = document.getElementById('productos-container');
            const toppingsContainer = document.getElementById('toppings-container');
            const jarabesContainer = document.getElementById('jarabes-container');
            const cartItemsEl = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const orderForm = document.getElementById('order-form');
            const submitBtn = document.getElementById('submit-order-btn');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const currentItemTotalEl = document.getElementById('current-item-total');
            const themeToggle = document.getElementById('theme-toggle');
            const menuLogo = document.getElementById('menu-logo'); // Variable para el logo

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    themeToggle.checked = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    themeToggle.checked = false;
                }
            }

            themeToggle.addEventListener('change', () => {
                const theme = themeToggle.checked ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            });

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }

            async function fetchData() {
                try {
                    const [productosRes, toppingsRes, jarabesRes, configRes] = await Promise.all([
                        fetch('/api/productos'),
                        fetch('/api/toppings'),
                        fetch('/api/jarabes'),
                        fetch('/api/configuracion')
                    ]);
                    
                    if (!productosRes.ok || !toppingsRes.ok || !jarabesRes.ok) throw new Error("No se pudieron cargar los datos del menú.");

                    productos = await productosRes.json();
                    toppings = await toppingsRes.json();
                    jarabes = await jarabesRes.json();
                    
                    const config = await configRes.json().catch(() => ({}));
                    
                    // == MEJORA ANTI-FLICKER: LÓGICA PARA CARGAR Y REVELAR EL LOGO ==
                    if (config.logo_base64) {
                        menuLogo.src = config.logo_base64;
                    } else {
                        // Si no hay logo, podemos poner uno por defecto o dejarlo vacío
                        menuLogo.src = "https://via.placeholder.com/200x80.png?text=Dulces+Amigas";
                    }
                    menuLogo.classList.add('loaded'); // Añade la clase para revelar el logo con la animación
                    
                    if (config.primary_color) document.documentElement.style.setProperty('--primary-color', config.primary_color);
                    if (config.accent_color) document.documentElement.style.setProperty('--accent-color', config.accent_color);

                    renderMenu();
                } catch (error) {
                    console.error('Error al cargar el menú:', error);
                    productosContainer.innerHTML = `<p style="color: var(--danger-color);">${error.message}</p>`;
                    menuLogo.src = "https://via.placeholder.com/200x80.png?text=Error"; // Muestra un logo de error si todo falla
                    menuLogo.classList.add('loaded'); // Asegúrate de mostrar el logo de error
                }
            }

            function renderMenu() {
                const createItemHTML = (item, tipo) => `
                    <div class="menu-item ${item.agotado ? 'agotado' : ''}" data-id="${item.id}" data-tipo="${tipo}">
                        ${item.agotado ? '<div class="agotado-badge">Agotado</div>' : ''}
                        <h4>${item.nombre}</h4>
                        <p>$${item.precio.toFixed(2)}</p>
                    </div>`;

                productosContainer.innerHTML = productos.map(p => createItemHTML(p, 'producto')).join('');
                toppingsContainer.innerHTML = toppings.map(t => createItemHTML(t, 'topping')).join('');
                jarabesContainer.innerHTML = jarabes.map(j => createItemHTML(j, 'jarabe')).join('');
                
                addEventListenersToItems();
            }

            function addEventListenersToItems() {
                document.querySelectorAll('.menu-item').forEach(itemEl => {
                    itemEl.addEventListener('click', () => {
                        if (itemEl.classList.contains('agotado')) return;
                        
                        const id = itemEl.dataset.id;
                        const tipo = itemEl.dataset.tipo;
                        
                        if (tipo === 'producto') {
                            if (seleccionActual.producto && seleccionActual.producto.id === id) {
                                seleccionActual.producto = null;
                                itemEl.classList.remove('selected');
                            } else {
                                document.querySelectorAll('.menu-item[data-tipo="producto"].selected').forEach(el => el.classList.remove('selected'));
                                seleccionActual.producto = productos.find(p => p.id === id);
                                itemEl.classList.add('selected');
                            }
                        } else {
                            const lista = tipo === 'topping' ? seleccionActual.toppings : seleccionActual.jarabes;
                            const itemData = (tipo === 'topping' ? toppings : jarabes).find(i => i.id === id);
                            const index = lista.findIndex(i => i.id === id);

                            if (index > -1) {
                                lista.splice(index, 1);
                                itemEl.classList.remove('selected');
                            } else {
                                lista.push(itemData);
                                itemEl.classList.add('selected');
                            }
                        }
                        updateCurrentItemTotal();
                    });
                });
            }

            function updateCurrentItemTotal() {
                if (!seleccionActual.producto) {
                    currentItemTotalEl.textContent = 'Subtotal Producto: $0.00';
                    addToCartBtn.disabled = true;
                    return;
                }

                let subtotal = seleccionActual.producto.precio;
                subtotal += seleccionActual.toppings.reduce((sum, t) => sum + t.precio, 0);
                subtotal += seleccionActual.jarabes.reduce((sum, j) => sum + j.precio, 0);
                
                currentItemTotalEl.textContent = `Subtotal Producto: $${subtotal.toFixed(2)}`;
                addToCartBtn.disabled = false;
            }

            function resetCurrentSelection() {
                seleccionActual = { producto: null, toppings: [], jarabes: [] };
                document.querySelectorAll('.menu-item.selected').forEach(el => el.classList.remove('selected'));
                updateCurrentItemTotal();
            }

            function renderCart() {
                if (carrito.length === 0) {
                    cartItemsEl.innerHTML = '<p style="color: var(--text-color-light);">Aún no has agregado productos a tu pedido.</p>';
                    cartTotalEl.textContent = 'Total del Pedido: $0.00';
                    return;
                }

                cartItemsEl.innerHTML = '';
                let granTotal = 0;

                carrito.forEach((item, index) => {
                    const itemTotal = item.producto.precio + 
                                      item.toppings.reduce((sum, t) => sum + t.precio, 0) + 
                                      item.jarabes.reduce((sum, j) => sum + j.precio, 0);
                    granTotal += itemTotal;

                    let extrasHTML = '';
                    if (item.toppings.length > 0 || item.jarabes.length > 0) {
                        extrasHTML += '<ul>';
                        item.toppings.forEach(t => extrasHTML += `<li>+ ${t.nombre}</li>`);
                        item.jarabes.forEach(j => extrasHTML += `<li>+ ${j.nombre}</li>`);
                        extrasHTML += '</ul>';
                    }

                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.innerHTML = `
                        <div class="cart-item-details">
                            <strong>1x ${item.producto.nombre}</strong>
                            ${extrasHTML}
                        </div>
                        <div class="cart-item-actions">
                            <span class="price">$${itemTotal.toFixed(2)}</span>
                            <button data-index="${index}">Eliminar</button>
                        </div>
                    `;
                    cartItemsEl.appendChild(cartItem);
                });
                
                cartItemsEl.querySelectorAll('.cart-item-actions button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const indexToRemove = parseInt(e.target.dataset.index);
                        carrito.splice(indexToRemove, 1);
                        renderCart();
                    });
                });

                cartTotalEl.textContent = `Total del Pedido: $${granTotal.toFixed(2)}`;
            }

            addToCartBtn.addEventListener('click', () => {
                if (!seleccionActual.producto) return;
                carrito.push(JSON.parse(JSON.stringify(seleccionActual)));
                renderCart();
                resetCurrentSelection();
            });

            orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (carrito.length === 0) {
                    alert('Tu pedido está vacío. Por favor, agrega al menos un producto.');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';

                const orderData = {
                    nombreCliente: document.getElementById('nombreCliente').value,
                    telefonoCliente: document.getElementById('telefonoCliente').value,
                    items: carrito.map(item => {
                        const totalItem = item.producto.precio + 
                                         item.toppings.reduce((s,t) => s + t.precio, 0) +
                                         item.jarabes.reduce((s,j) => s + j.precio, 0);
                        return {
                            nombre: item.producto.nombre,
                            precio: item.producto.precio,
                            toppings: item.toppings,
                            jarabes: item.jarabes,
                            total: totalItem
                        }
                    }),
                    total: carrito.reduce((granTotal, item) => {
                        return granTotal + item.producto.precio + 
                               item.toppings.reduce((s,t) => s + t.precio, 0) +
                               item.jarabes.reduce((s,j) => s + j.precio, 0);
                    }, 0)
                };

                try {
                    const response = await fetch('/api/pedidos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                    
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Error desconocido del servidor.');
                    
                    alert('¡Tu pedido ha sido recibido! Gracias por tu preferencia.');
                    carrito = [];
                    orderForm.reset();
                    renderCart();

                } catch (error) {
                    alert('Hubo un error al enviar tu pedido: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Realizar Pedido';
                }
            });

            fetchData();
        });
    </script>
</body>
</html>