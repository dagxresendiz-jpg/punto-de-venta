<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dulces Amigas - Punto de Venta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4f46e5; 
      --accent-color: #FF85A2;
      --primary-hover: #4338ca; --danger-color: #ef4444; --danger-hover: #dc2626;
      --success-color: #22c55e; --success-hover: #16a34a; --info-color: #38bdf8; --info-hover: #0ea5e9;
      --background-color: #f8fafc; --card-background: #ffffff; --text-color-dark: #1e293b; 
      --text-color-light: #64748b; --border-color: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --form-control-bg: #ffffff;
      --collapsible-bg: #f1f5f9;
      --table-header-bg: #f8fafc;
      --secondary-button-bg: #f1f5f9;
      --secondary-button-text: #1e293b;
      --secondary-button-hover-bg: #e2e8f0;
    }
    
    body.dark-mode {
      --background-color: #1e293b;
      --card-background: #334155;
      --text-color-dark: #f1f5f9;
      --text-color-light: #94a3b8;
      --border-color: #475569;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2);
      --form-control-bg: #475569;
      --collapsible-bg: #475569;
      --table-header-bg: #1e293b;
      --secondary-button-bg: #475569;
      --secondary-button-text: #f1f5f9;
      --secondary-button-hover-bg: #525f75;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color-dark); -webkit-font-smoothing: antialiased; }
    .app-wrapper { display: flex; min-height: 100vh; }
    .sidebar { width: 250px; background-color: var(--card-background); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem 1rem; transition: transform 0.3s ease; }
    .sidebar-header { text-align: center; margin-bottom: 2rem; }
    #app-logo { max-width: 180px; max-height: 80px; cursor: pointer; transition: transform 0.2s ease; }
    #app-logo:hover { transform: scale(1.05); }
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px; text-decoration: none; color: var(--text-color-light); font-weight: 500; transition: all 0.2s ease; cursor: pointer; }
    .nav-link:hover { background-color: var(--background-color); color: var(--primary-color); }
    .nav-link.active-link { background-color: var(--primary-color); color: white; }
    .nav-link svg { width: 20px; height: 20px; stroke-width: 2; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    #logout-button { width: 100%; justify-content: center; background-color: var(--danger-color); color: white; border: none; font-weight: 500; }
    #logout-button:hover { background-color: var(--danger-hover); }
    .main-content { flex: 1; display: flex; flex-direction: column; }
    .main-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); }
    .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color-dark); }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    main { padding: 2rem; overflow-y: auto; }
    section { display: none; }
    section.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background-color: var(--card-background); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
    .card-header { margin-bottom: 1.5rem; }
    .card-header h2 { font-size: 1.25rem; font-weight: 600; border: none; padding: 0; }
    .card h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-weight: 600; }
    .card h3:first-child { margin-top: 0; }
    form label { display: block; margin-bottom: 0.5rem; font-weight: 500; text-align: left; color: var(--text-color-dark); }
    form input, form select { background-color: var(--form-control-bg); color: var(--text-color-dark); display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; transition: box-shadow 0.2s, border-color 0.2s; }
    form input::placeholder { color: var(--text-color-light); opacity: 0.8; }
    form input:focus, form select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px #c7d2fe; outline: none; }
    form select:disabled { background-color: #475569; cursor: not-allowed; opacity: 0.7; }
    .password-wrapper { position: relative; display: flex; align-items: center; }
    .password-wrapper input { padding-right: 3rem; }
    #toggle-password { position: absolute; right: 1rem; top: 0.75rem; cursor: pointer; color: var(--text-color-light); }
    #toggle-password svg { width: 20px; height: 20px; }
    button { cursor: pointer; border-radius: 8px; border: none; padding: 0.75rem 1.25rem; font-weight: 600; transition: all 0.2s; }
    button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    button[type="submit"], #btnAgregarVenta { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover, #btnAgregarVenta:hover { background-color: var(--primary-hover); }
    .btn-secondary { background-color: var(--secondary-button-bg); color: var(--secondary-button-text); }
    .btn-secondary:hover { background-color: var(--secondary-button-hover-bg); }
    .btn-eliminar-item, .btn-eliminar-venta { background-color: var(--danger-color); color: white; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
    #listaVentaActual { margin-bottom: 1rem; }
    #listaVentaActual li { flex-direction: column; align-items: stretch; }
    #opcion-domicilio { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
    #opcion-domicilio > div { display: flex; align-items: center; gap: 0.5rem; }
    #opcion-domicilio input[type="checkbox"] { width: auto; margin: 0; }
    #opcion-domicilio input[type="number"] { width: 100px; margin: 0; padding: 0.5rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--table-header-bg); font-weight: 600; color: var(--text-color-light); }
    #login-container { max-width: 400px; margin: 15vh auto; background: var(--card-background); box-shadow: var(--shadow); border-radius: 12px; }
    .collapsible { background-color: var(--collapsible-bg); color: var(--text-color-dark); }
    .collapsible-wrapper { margin-bottom: 1rem; }
    .collapsible { width: 100%; text-align: left; font-weight: 500; border: 1px solid var(--border-color); border-radius: 8px; }
    .content-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
    .options-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; }
    .option-btn { padding: 0.5rem 1rem; font-weight: 500; background-color: var(--background-color); color: var(--text-color-dark); border: 1px solid var(--border-color); }
    .option-btn.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    #btnGenerarReporte { background-color: var(--info-color); color: white; }
    #btnGenerarPDF { background-color: #E53E3E; color: white; }
    #btnGenerarPDF:hover { background-color: #C53030; }
    #btnEnviarWhatsapp { background-color: #25D366; color: white; }
    #btnEnviarWhatsapp:hover { background-color: #128C7E; }
    .chart-container { position: relative; width: 100%; }
    #totalPeriodoHistorial { font-weight: bold; font-size: 1.3em; text-align: center; margin-bottom: 1.5rem; padding: 1rem; background-color: #22c55e20; color: var(--success-color); border: 1px solid var(--success-color); border-radius: 8px; }
    #filtros-historial { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end; }
    #filtros-historial > div { flex: 1 1 200px; }
    #filtros-historial label { font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-color-dark); display: block; }
    #botones-periodo { display: flex; gap: 0.5rem; }
    #botones-periodo button { background-color: var(--card-background); color: var(--text-color-light); border: 1px solid var(--border-color); font-weight: 500; padding: 0.75rem 1rem; }
    #botones-periodo button:hover { background-color: var(--secondary-button-hover-bg); }
    #botones-periodo button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    #resumen-ventas { white-space: pre-wrap; word-break: break-word; }
    #botones-finalizar-venta { display: flex; gap: 1rem; }
    #botones-finalizar-venta button { flex: 1; }
    #btnRegistrarPagado { background-color: var(--success-color); color: white; }
    #btnRegistrarPagado:hover { background-color: var(--success-hover); }
    #btnRegistrarPendiente { background-color: var(--info-color); color: white; }
    #btnRegistrarPendiente:hover { background-color: var(--info-hover); }
    .status-badge { padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em; font-weight: 600; color: white; text-align: center; display: inline-block; }
    .status-pagado { background-color: #16a34a; }
    .status-pendiente { background-color: #f59e0b; }
    .status-na { background-color: var(--text-color-light); }
    .btn-marcar-pagado { background-color: var(--success-color); color: white; padding: 0.4rem 0.8rem; font-size: 0.8em; margin-right: 0.5rem; }
    .btn-marcar-pagado:hover { background-color: var(--success-hover); }
    .btn-reimprimir, .btn-editar-venta { background-color: var(--primary-color); color: white; padding: 0.4rem; font-size: 0.8em; line-height: 1; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; margin-right: 0.5rem; }
    .btn-reimprimir svg, .btn-editar-venta svg { width: 16px; height: 16px; }
    .btn-cambiar-estatus { background: none; border: none; padding: 0; margin-left: 0.5rem; cursor: pointer; color: var(--text-color-light); }
    .btn-cambiar-estatus:hover { color: var(--primary-color); }
    .btn-cambiar-estatus svg { width: 16px; height: 16px; }
    .btn-restaurar { background-color: var(--success-color); color: white; }
    .btn-eliminar-perm { background-color: var(--danger-color); color: white; }
    .full-width-card { grid-column: 1 / -1; }
    #permisos-container { border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    #permisos-container label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    #permisos-container input[type="checkbox"] { width: auto; margin: 0; }
    .theme-toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; margin-bottom: 0.5rem; }
    .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(24px); }

    @media (max-width: 992px) {
      .menu-toggle { display: block; }
      .sidebar { position: fixed; left: 0; top: 0; bottom: 0; z-index: 1000; transform: translateX(-100%); }
      .sidebar.nav-open { transform: translateX(0); }
      .app-wrapper { display: block; }
      main { padding: 1rem; }
      .card { padding: 1rem; }
      #opcion-domicilio { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
    }
  </style>
</head>
<body>

  <div id="login-container" class="card">
    <div style="text-align: center; margin-bottom: 1.5rem;">
        <img id="login-logo" src="https://via.placeholder.com/180x60.png?text=Cargando..." alt="Logotipo" style="max-width: 180px; max-height: 70px;">
    </div>
    <div class="card-header"><h2 style="text-align: center;">Iniciar Sesión</h2></div>
    <form id="login-form">
      <div><label for="username">Usuario</label><input type="text" id="username" required></div>
      <div>
        <label for="password">Contraseña</label>
        <div class="password-wrapper">
          <input type="password" id="password" required>
          <span id="toggle-password">
              <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              <svg id="eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
          </span>
        </div>
      </div>
      <button type="submit" style="width:100%;">Entrar</button>
      <p id="login-error"></p>
    </form>
  </div>

  <div id="app-wrapper" style="display:none;">
    <nav class="sidebar">
      <div class="sidebar-header">
        <img id="app-logo" src="https://via.placeholder.com/180x60.png?text=Cargando..." alt="Logotipo">
      </div>
      <div class="sidebar-nav">
        <a class="nav-link" data-seccion="registrar-venta"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-6.967c.124-.467-.202-1.026-.693-1.026H6.118" /></svg><span>Registrar Venta</span></a>
        <a class="nav-link" data-seccion="gestion-completa" id="btn-gestion"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg><span>Gestión</span></a>
        <a class="nav-link" data-seccion="gestion-clientes" id="btn-clientes"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663c.278.472.548.972.786 1.503z" /></svg><span>Clientes</span></a>
        <a class="nav-link" data-seccion="gestion-usuarios" id="btn-usuarios"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962c.57-1.023.994-2.131 1.253-3.284C13.437 11.08 14 9.61 14 8c0-1.61-.563-3.08-1.5-4.216m-4.5 14.15a9.083 9.083 0 01-1.253-3.284C6.563 13.08 6 11.61 6 10c0-1.61.563-3.08 1.5-4.216m0 0a5.012 5.012 0 011.5 0c.828 1.136 1.5 2.606 1.5 4.216 0 1.61-.563-3.08-1.5 4.216m0 0l-2.25 2.25a5.012 5.012 0 01-1.5 0l-2.25-2.25m0 0a5.012 5.012 0 00-1.5 0l-2.25 2.25a5.012 5.012 0 00-1.5 0l-2.25-2.25m0 0a5.012 5.012 0 01-1.5 0l-2.25 2.25" /></svg><span>Usuarios</span></a>
        <a class="nav-link" data-seccion="historial-ventas" id="btn-historial"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m1-1.5l1-1.5m0 0l1 1.5m-2-1.5v-6.375c0-1.125.9-2.025 2-2.025h.5c1.1 0 2 .9 2 2.025v6.375m-4.5-3.375V8.25" /></svg><span>Historial</span></a>
        <a class="nav-link" data-seccion="papelera-reciclaje" id="btn-papelera"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg><span>Papelera</span></a>
      </div>
      <div class="sidebar-footer">
        <div id="customization-container" style="display: none;">
            <div id="customization-controls" style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; color: var(--text-color-light); font-weight: 500;">Personalizar Apariencia</h4>
                <input type="file" id="logo-input" accept="image/*" style="display: none;">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; align-items: center;">
                    <label for="primary-color-picker" style="font-size: 0.9em;">Primario:</label>
                    <input type="color" id="primary-color-picker" style="width: 100%; height: 25px; border: none; background: none; cursor: pointer;">
                    <label for="accent-color-picker" style="font-size: 0.9em;">Acento:</label>
                    <input type="color" id="accent-color-picker" style="width: 100%; height: 25px; border: none; background: none; cursor: pointer;">
                </div>
            </div>
        </div>
        <div class="theme-toggle-container">
            <span>Modo Oscuro</span>
            <label class="theme-switch" for="theme-switch">
                <input type="checkbox" id="theme-switch" />
                <span class="slider"></span>
            </label>
        </div>
        <button id="logout-button">Cerrar Sesión</button>
      </div>
    </nav>
    <div class="main-content">
      <header class="main-header">
        <button class="menu-toggle" id="menu-toggle">&#9776;</button>
        <div class="user-info">
          <span id="welcome-user"></span>
        </div>
      </header>
      <main>
        <section id="registrar-venta">
            <div class="grid-container">
                <div class="card">
                    <div class="card-header"><h2>Registrar Venta</h2></div>
                    <form id="formVenta" onsubmit="return false;">
                        <input type="hidden" id="idVenta">
                        <label for="ventaCliente">Cliente:</label> <select id="ventaCliente"></select>
                        <label for="ventaProducto">Producto:</label> <select id="ventaProducto" required></select>
                        <label for="ventaCantidad">Cantidad:</label> <input type="number" id="ventaCantidad" min="1" value="1" required />
                        <div class="collapsible-wrapper">
                            <button type="button" class="collapsible">Seleccionar Toppings</button>
                            <div class="content-collapsible"><div class="options-grid" id="toppings-container"></div></div>
                        </div>
                        <div class="collapsible-wrapper">
                            <button type="button" class="collapsible">Seleccionar Jarabes</button>
                            <div class="content-collapsible"><div class="options-grid" id="jarabes-container"></div></div>
                        </div>
                        <div id="opcion-domicilio">
                            <div><input type="checkbox" id="checkDomicilio"><label for="checkDomicilio">Servicio a domicilio</label></div>
                            <input type="number" id="costoDomicilio" step="0.01" placeholder="Costo" style="display: none;">
                        </div>
                        <label for="ventaNota">Nota para este producto (opcional):</label>
                        <input type="text" id="ventaNota" placeholder="Ej: Sin nuez, extra chocolate, etc." />
                        <button id="btnAgregarVenta" type="button">Agregar a Venta Actual</button>
                    </form>
                </div>
                <div>
                    <div class="card">
                        <div class="card-header"><h3>Venta Actual</h3></div>
                        <ul id="listaVentaActual"></ul>
                        <div id="totalVenta" style="font-weight:600; font-size: 1.2rem; margin-top: 1rem; text-align: right;">Total venta actual: $0.00</div>
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border-color);">
                        <label for="metodoPago">Método de Pago:</label>
                        <select id="metodoPago">
                            <option value="Efectivo">Efectivo</option> <option value="Tarjeta">Tarjeta</option> <option value="Transferencia">Transferencia</option>
                        </select>
                        <div id="botones-accion-venta" style="margin-top: 1rem;">
                            <div id="botones-finalizar-venta" class="botones-grupo" style="display: flex; gap: 1rem;">
                                <button id="btnRegistrarPendiente" style="flex: 1;">Guardar Pendiente</button>
                                <button id="btnRegistrarPagado" style="flex: 1;">Cobrar y Finalizar</button>
                            </div>
                            <button id="btnActualizarVenta" style="display:none; width: 100%;" class="btn-secondary">Actualizar Venta</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Ticket</h3></div>
                        <pre id="ticket"></pre>
                        <div style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <button id="btnGenerarPDF" style="flex:1;">Generar PDF</button>
                            <button id="btnEnviarWhatsapp" style="flex:1;">Enviar WhatsApp</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="gestion-completa">
          <div class="grid-container">
            <div class="card">
              <div class="card-header"><h2>Gestión de Inventario</h2></div>
              <h3>Productos</h3>
              <form id="formProducto"><input type="hidden" id="idProducto" /><input type="text" id="nombreProducto" placeholder="Nombre producto" required /><input type="number" step="0.01" id="precioProducto" placeholder="Precio" required /><button type="submit">Guardar Producto</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
              <ul id="listaProductos"></ul>
            </div>
            <div class="card">
              <h3>Toppings</h3>
              <form id="formTopping"><input type="hidden" id="idTopping" /><input type="text" id="nombreTopping" placeholder="Nombre topping" required /><input type="number" step="0.01" id="precioTopping" placeholder="Precio" required /><button type="submit">Guardar Topping</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
              <ul id="listaToppings"></ul>
            </div>
            <div class="card">
              <h3>Jarabes</h3>
              <form id="formJarabe"><input type="hidden" id="idJarabe" /><input type="text" id="nombreJarabe" placeholder="Nombre jarabe" required /><input type="number" step="0.01" id="precioJarabe" placeholder="Precio" required /><button type="submit">Guardar Jarabe</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
              <ul id="listaJarabes"></ul>
            </div>
          </div>
        </section>
        <section id="gestion-clientes">
          <div class="card">
            <div class="card-header"><h2>Gestión de Clientes</h2></div>
            <form id="formCliente"><input type="hidden" id="idCliente" /><input type="text" id="nombreCliente" placeholder="Nombre del cliente" required /><input type="text" id="telCliente" placeholder="Teléfono (opcional)" /><input type="text" id="dirCliente" placeholder="Dirección (opcional)" /><button type="submit">Guardar Cliente</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
            <ul id="listaClientes"></ul>
          </div>
        </section>
        <section id="gestion-usuarios">
          <div class="card">
            <div class="card-header"><h2>Gestión de Usuarios</h2></div>
            <form id="formUsuario">
              <input type="hidden" id="idUsuario" />
              <input type="text" id="usernameUsuario" placeholder="Nombre de usuario" required />
              <input type="password" id="passwordUsuario" placeholder="Contraseña (dejar en blanco para no cambiar)" />
              <select id="roleUsuario" required>
                  <option value="">-- Seleccionar Rol --</option>
                  <option value="seller">Vendedor</option>
                  <option value="admin">Administrador</option>
              </select>
              <div id="permisos-container">
                  <h3>Permisos</h3>
                  <label><input type="checkbox" name="permisos" value="gestion"> Acceso a Gestión de Inventario</label>
                  <label><input type="checkbox" name="permisos" value="clientes"> Acceso a Clientes</label>
                  <label><input type="checkbox" name="permisos" value="historial"> Acceso a Historial</label>
                  <label><input type="checkbox" name="permisos" value="papelera"> Acceso a Papelera</label>
                  <label><input type="checkbox" name="permisos" value="usuarios"> Acceso a Gestión de Usuarios</label>
              </div>
              <button type="submit">Guardar Usuario</button>
              <button type="button" id="btnLimpiarFormUsuario" class="btn-secondary">Limpiar</button>
            </form>
            <h3>Usuarios Existentes</h3>
            <ul id="listaUsuarios"></ul>
          </div>
        </section>
        <section id="historial-ventas">
          <div class="card">
            <div class="card-header"><h2>Historial de Ventas</h2></div>
            <div id="filtros-historial">
                <div>
                    <label>Período</label>
                    <div id="botones-periodo">
                        <button data-periodo="dia" class="active">Hoy</button>
                        <button data-periodo="semana">Semana</button>
                        <button data-periodo="mes">Mes</button>
                    </div>
                </div>
                <div>
                    <label for="filtroEstatus">Filtrar por Estatus</label>
                    <select id="filtroEstatus">
                        <option value="">Todos</option>
                        <option value="Pagado">Pagado</option>
                        <option value="Pendiente de Pago">Pendiente de Pago</option>
                    </select>
                </div>
                <div>
                    <label for="filtroCliente">Filtrar por Cliente</label>
                    <select id="filtroCliente"></select>
                </div>
                <div id="filtro-usuario-container">
                    <label for="filtroUsuario">Filtrar por Vendedor</label>
                    <select id="filtroUsuario"></select>
                </div>
            </div>
          </div>
          <div class="grid-container">
            <div class="card">
                <h3>Ventas por Día</h3>
                <div class="chart-container"><canvas id="graficaVentas"></canvas></div>
            </div>
            <div class="card">
                <h3>Productos Más Vendidos</h3>
                <div class="chart-container"><canvas id="graficaProductos"></canvas></div>
            </div>
            <div class="card" id="resumen-container">
                <h3>Resumen de Ventas del Período</h3>
                <div id="totalPeriodoHistorial"></div>
                <pre id="resumen-ventas"></pre>
                <button id="btnGenerarReporte">Generar Reporte PDF</button>
            </div>
            <div class="card full-width-card">
                <h3>Detalle de Ventas</h3>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr>
                          <th>ID Venta</th>
                          <th>Vendedor</th>
                          <th>Cliente</th>
                          <th>Total</th>
                          <th>Método de Pago</th>
                          <th>Estatus</th>
                          <th>Fecha</th>
                          <th>Acciones</th>
                        </tr></thead>
                        <tbody id="tablaVentasBody"></tbody>
                    </table>
                </div>
            </div>
          </div>
        </section>
        <section id="papelera-reciclaje">
            <div class="card">
                <div class="card-header"><h2>Papelera de Reciclaje</h2></div>
                <p>Aquí se muestran los elementos eliminados. Puedes restaurarlos o eliminarlos permanentemente.</p>
            </div>
            <div class="grid-container">
                <div class="card"><h3>Productos Eliminados</h3><ul id="papelera-productos"></ul></div>
                <div class="card"><h3>Toppings Eliminados</h3><ul id="papelera-toppings"></ul></div>
                <div class="card"><h3>Jarabes Eliminados</h3><ul id="papelera-jarabes"></ul></div>
                <div class="card"><h3>Clientes Eliminados</h3><ul id="papelera-clientes"></ul></div>
                <div class="card"><h3>Usuarios Eliminados</h3><ul id="papelera-usuarios"></ul></div>
                <div class="card full-width-card">
                    <h3>Ventas Eliminadas</h3>
                    <div style="overflow-x:auto;">
                        <table id="papelera-ventas-tabla">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="papelera-ventas"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      let ventaActual = [];
      let miGraficaDeVentas, miGraficaDeProductos;
      let ventasEnMemoria = [];
      let procesandoVenta = false;
      const COSTO_DOMICILIO_PREDET = 30.00;
      
      const loginContainer = document.getElementById('login-container');
      const appWrapper = document.getElementById('app-wrapper');
      const loginForm = document.getElementById('login-form');
      const logoutButton = document.getElementById('logout-button');
      const welcomeUserSpan = document.getElementById('welcome-user');
      const loginError = document.getElementById('login-error');
      const nav = document.querySelector('nav');
      const menuToggle = document.getElementById('menu-toggle');
      const mainContent = document.querySelector('.main-content');
      const { jsPDF } = window.jspdf;
      
      const themeSwitch = document.getElementById('theme-switch');
      const togglePassword = document.getElementById('toggle-password');
      const passwordInput = document.getElementById('password');
      const eyeOpen = document.getElementById('eye-open');
      const eyeClosed = document.getElementById('eye-closed');

      function applyTheme(theme) {
          if (theme === 'dark') {
              document.body.classList.add('dark-mode');
              themeSwitch.checked = true;
          } else {
              document.body.classList.remove('dark-mode');
              themeSwitch.checked = false;
          }
      }
      
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme) {
          applyTheme(savedTheme);
      } else if (systemPrefersDark) {
          applyTheme('dark');
      } else {
          applyTheme('light');
      }

      menuToggle.addEventListener('click', () => nav.classList.toggle('nav-open'));

      async function guardarConfiguracionServidor(config) {
          try {
              await fetchAPI('/api/configuracion', { 
                  method: 'POST', 
                  body: JSON.stringify(config) 
              }, true);
          } catch (error) {
              console.error("Error guardando configuración:", error);
              alert("No se pudo guardar la configuración. Revisa la conexión con el servidor.");
          }
      }

      function setupCustomizationEventListeners() {
          const logoInput = document.getElementById('logo-input');
          const appLogo = document.getElementById('app-logo');
          const primaryColorPicker = document.getElementById('primary-color-picker');
          const accentColorPicker = document.getElementById('accent-color-picker');
          const root = document.documentElement;

          appLogo.addEventListener('click', () => logoInput.click());

          logoInput.addEventListener('change', (event) => {
              const file = event.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      const logo_base64 = e.target.result;
                      document.getElementById('app-logo').src = logo_base64;
                      document.getElementById('login-logo').src = logo_base64;
                      guardarConfiguracionServidor({ logo_base64 });
                  };
                  reader.readAsDataURL(file);
              }
          });

          primaryColorPicker.addEventListener('input', (event) => {
              const primary_color = event.target.value;
              root.style.setProperty('--primary-color', primary_color);
              guardarConfiguracionServidor({ primary_color });
          });
          
          accentColorPicker.addEventListener('input', (event) => {
              const accent_color = event.target.value;
              root.style.setProperty('--accent-color', accent_color);
              guardarConfiguracionServidor({ accent_color });
          });
      }

      async function loadPublicConfig() {
          const appLogo = document.getElementById('app-logo');
          const loginLogo = document.getElementById('login-logo');
          const primaryColorPicker = document.getElementById('primary-color-picker');
          const accentColorPicker = document.getElementById('accent-color-picker');
          const root = document.documentElement;
          
          try {
              const response = await fetch('/api/configuracion');
              if (!response.ok) {
                  throw new Error(`Error de red: ${response.statusText}`);
              }
              const config = await response.json();
              
              const defaultLogo = 'https://via.placeholder.com/180x60.png?text=Tu+Logo';
              
              if (config && config.logo_base64) {
                  appLogo.src = config.logo_base64;
                  loginLogo.src = config.logo_base64;
              } else {
                   appLogo.src = defaultLogo;
                   loginLogo.src = defaultLogo;
              }

              if (config && config.primary_color) {
                  root.style.setProperty('--primary-color', config.primary_color);
                  primaryColorPicker.value = config.primary_color;
              }

              if (config && config.accent_color) {
                  root.style.setProperty('--accent-color', config.accent_color);
                  accentColorPicker.value = config.accent_color;
              }
          } catch (error) {
              console.error("No se pudo cargar la configuración de apariencia desde el servidor.", error);
              const errorLogo = 'https://via.placeholder.com/180x60.png?text=Error';
              appLogo.src = errorLogo;
              loginLogo.src = errorLogo;
          }
      }

      async function showApp() {
        try {
            const token = localStorage.getItem('token');
            const payload = JSON.parse(atob(token.split('.')[1]));
            welcomeUserSpan.textContent = `Bienvenido, ${payload.username} (${payload.role})`;
            
            const esAdmin = payload.role === 'admin';
            const permisos = payload.permissions || {};

            const mapaPermisos = {
                'gestion': document.getElementById('btn-gestion'),
                'clientes': document.getElementById('btn-clientes'),
                'usuarios': document.getElementById('btn-usuarios'),
                'historial': document.getElementById('btn-historial'),
                'papelera': document.getElementById('btn-papelera')
            };
            
            let primeraSeccionVisible = 'registrar-venta'; // Por defecto para todos
            let algunaSeccionVisible = true;

            for (const permiso in mapaPermisos) {
                const tieneAcceso = esAdmin || (permisos && permisos[permiso]);
                if (mapaPermisos[permiso]) {
                    mapaPermisos[permiso].style.display = tieneAcceso ? 'flex' : 'none';
                }
            }
            
            document.getElementById('customization-container').style.display = esAdmin ? 'block' : 'none';
            document.getElementById('filtro-usuario-container').style.display = esAdmin ? 'block' : 'none';

            if (!esAdmin) {
                const ordenDeSecciones = [
                    'registrar-venta', 'gestion-completa', 'gestion-clientes', 
                    'historial-ventas', 'papelera-reciclaje', 'gestion-usuarios'
                ];
                const mapaSeccionesAPermisos = {
                    'gestion-completa': 'gestion',
                    'gestion-clientes': 'clientes',
                    'gestion-usuarios': 'usuarios',
                    'historial-ventas': 'historial',
                    'papelera-reciclaje': 'papelera'
                };
                
                let primeraEncontrada = false;
                for(const seccion of ordenDeSecciones) {
                    if (seccion === 'registrar-venta') {
                        primeraSeccionVisible = 'registrar-venta';
                        primeraEncontrada = true;
                        break;
                    }
                    const permisoNecesario = mapaSeccionesAPermisos[seccion];
                    if(permisos[permisoNecesario]){
                        primeraSeccionVisible = seccion;
                        primeraEncontrada = true;
                        break;
                    }
                }
                if(!primeraEncontrada){
                    algunaSeccionVisible = false;
                }
            }

            appWrapper.style.display = 'flex';
            loginContainer.style.display = 'none';

            initApp();

            if (algunaSeccionVisible) {
                mostrarSeccion(primeraSeccionVisible);
            } else {
                alert('No tienes permisos asignados para ver ninguna sección. Contacta a un administrador.');
                document.querySelector('main').innerHTML = '<div class="card"><p>No tienes acceso a ninguna sección.</p></div>';
            }

        } catch (e) { 
            console.error("Error en showApp:", e); 
            localStorage.removeItem('token');
            showLogin();
        }
      }
      
      function showLogin() {
        localStorage.removeItem('token');
        appWrapper.style.display = 'none';
        loginContainer.style.display = 'block';
      }
      
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const username = document.getElementById('username').value;
        const password = passwordInput.value;
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Credenciales inválidas');
            localStorage.setItem('token', data.token);
            await showApp();
        } catch (error) {
            loginError.textContent = error.message;
        }
      });

      logoutButton.addEventListener('click', () => { showLogin(); });
      
      async function fetchAPI(url, options = {}, suppressError = false) {
        const token = localStorage.getItem('token');
        if (!token) { showLogin(); throw new Error('No autenticado'); }
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (response.status === 204) return;
        if (response.status === 401) { showLogin(); throw new Error('Sesión expirada.'); }
        if (!response.ok) { 
            const errorData = await response.json(); 
            if (response.status === 403) { // Permiso denegado
              console.error(`Acceso denegado a ${url}:`, errorData.error);
              // No hacemos logout, simplemente no se cargará el contenido
            }
            if (suppressError) {
                console.error(`Error en la petición a ${url}:`, errorData.error);
                return;
            }
            throw new Error(errorData.error || `Error en la petición a ${url}`); 
        }
        return response.json();
      }
      
      function initApp() {
        setupEventListeners();
        setupCustomizationEventListeners();
        setupCollapsibles(); 
      }
      
      function mostrarSeccion(id) {
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(link => link.classList.remove('active-link'));
        const seccionActiva = document.getElementById(id);
        const linkActivo = document.querySelector(`nav a[data-seccion="${id}"]`);

        if (seccionActiva) {
          seccionActiva.classList.add('active');
          if (linkActivo) linkActivo.classList.add('active-link');
          const cargarMap = {
            'registrar-venta': () => cargarOpcionesParaVenta(),
            'gestion-completa': () => { cargarProductos(); cargarToppings(); cargarJarabes(); },
            'gestion-clientes': () => cargarClientes(),
            'gestion-usuarios': () => cargarUsuarios(),
            'historial-ventas': () => { cargarClientesParaFiltro(); cargarUsuariosParaFiltro(); cargarVentasHistorial(); },
            'papelera-reciclaje': () => cargarPapelera(),
          };
          cargarMap[id]?.();
        }
        nav.classList.remove('nav-open');
      }

      function setupCollapsibles() {
        document.querySelectorAll(".collapsible").forEach(c => {
          const newC = c.cloneNode(true);
          c.parentNode.replaceChild(newC, c);
          
          newC.addEventListener("click", function() {
            this.classList.toggle("active");
            const content = this.nextElementSibling;
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
              content.style.maxHeight = '0px';
            } else {
              content.style.maxHeight = content.scrollHeight + "px";
            }
          });
        });
      }
      
      const renderizarLista = (items = [], tipo, campos) => {
        const lista = document.getElementById(`lista${tipo}s`);
        if(!lista) return;
        lista.innerHTML = '';
        items.forEach(item => {
          const li = document.createElement('li');
          const texto = document.createElement('span');
          let displayText = item[campos[0]] || '';
          if (campos[1] && item[campos[1]]) {
            let secondField = (typeof item[campos[1]] === 'number') ? `$${item[campos[1]].toFixed(2)}` : item[campos[1]];
            displayText += ` - ${secondField}`;
          }
          texto.textContent = displayText;
          const divBotones = document.createElement('div');
          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.onclick = () => {
              if(tipo === 'Usuario') {
                  cargarUsuarioEnForm(item);
              } else {
                  document.getElementById(`id${tipo}`).value = item.id;
                  document.getElementById(`nombre${tipo}`).value = item.nombre;
                  if (tipo === 'Cliente') {
                    document.getElementById(`tel${tipo}`).value = item.telefono || '';
                    document.getElementById(`dir${tipo}`).value = item.direccion || '';
                  } else { document.getElementById(`precio${tipo}`).value = item.precio; }
              }
          };
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'Eliminar';
          btnEliminar.className = 'btn-eliminar-item';
          btnEliminar.onclick = () => eliminarItem(item.id, tipo);
          divBotones.appendChild(btnEditar);
          divBotones.appendChild(btnEliminar);
          li.appendChild(texto);
          li.appendChild(divBotones);
          lista.appendChild(li);
        });
      };
      
      async function guardarItem(e, tipo) {
        e.preventDefault();
        const form = e.target;
        const id = document.getElementById(`id${tipo}`).value;
        let body;
        if (tipo === 'Cliente') {
            body = { nombre: document.getElementById(`nombre${tipo}`).value, telefono: document.getElementById(`tel${tipo}`).value, direccion: document.getElementById(`dir${tipo}`).value };
            if (!body.nombre) { alert('El nombre del cliente es obligatorio.'); return; }
        } else {
            body = { nombre: document.getElementById(`nombre${tipo}`).value, precio: parseFloat(document.getElementById(`precio${tipo}`).value) };
            if (!body.nombre || isNaN(body.precio)) { alert('Completa los datos'); return; }
        }
        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/${tipo.toLowerCase()}s/${id}` : `/api/${tipo.toLowerCase()}s`;
        try {
          await fetchAPI(url, { method: metodo, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
          form.reset();
          document.getElementById(`id${tipo}`).value = '';
          await actualizarUIGlobal(tipo);
        } catch (err) { alert(`Error: ${err.message}`); }
      }

      async function eliminarItem(id, tipo) {
        if (confirm(`¿Mover este ${tipo.toLowerCase()} a la papelera?`)) {
          try {
            await fetchAPI(`/api/${tipo.toLowerCase()}s/${id}`, { method: 'DELETE' });
            await actualizarUIGlobal(tipo);
          } catch (err) { alert(`Error: ${err.message}`); }
        }
      }
      
      async function actualizarUIGlobal(tipo) {
        const cargaFuncs = {
          'Producto': [cargarProductos, cargarOpcionesParaVenta], 'Topping': [cargarToppings, cargarOpcionesParaVenta], 'Jarabe': [cargarJarabes, cargarOpcionesParaVenta],
          'Cliente': [cargarClientes, cargarOpcionesParaVenta, cargarClientesParaFiltro], 'Usuario': [cargarUsuarios, cargarUsuariosParaFiltro], 'Venta': [cargarVentasHistorial]
        };
        const funciones = cargaFuncs[tipo] || [];
        for (const func of funciones) { await func(); }
      }

      async function cargarProductos() { try { const data = await fetchAPI('/api/productos'); renderizarLista(data, 'Producto', ['nombre', 'precio']); } catch (e) { console.error(e); renderizarLista([], 'Producto', ['nombre', 'precio']); } }
      async function cargarToppings() { try { const data = await fetchAPI('/api/toppings'); renderizarLista(data, 'Topping', ['nombre', 'precio']); } catch (e) { console.error(e); renderizarLista([], 'Topping', ['nombre', 'precio']); } }
      async function cargarJarabes() { try { const data = await fetchAPI('/api/jarabes'); renderizarLista(data, 'Jarabe', ['nombre', 'precio']); } catch (e) { console.error(e); renderizarLista([], 'Jarabe', ['nombre', 'precio']); } }
      async function cargarClientes() { try { const data = await fetchAPI('/api/clientes'); renderizarLista(data, 'Cliente', ['nombre', 'telefono']); } catch (e) { console.error(e); renderizarLista([], 'Cliente', ['nombre', 'telefono']); } }
      
      async function cargarOpcionesParaVenta() { 
        try {
            await Promise.all([ 
                cargarDataParaSelector('/api/productos', 'ventaProducto', 'id', item => `${item.nombre} - $${item.precio.toFixed(2)}`), 
                cargarDataParaSelector('/api/clientes', 'ventaCliente', 'id', 'nombre'),
                cargarDataParaBotones('/api/toppings', 'toppings-container'),
                cargarDataParaBotones('/api/jarabes', 'jarabes-container') 
            ]);
            setupCollapsibles();
        } catch(e) {
            console.error("Fallo al cargar opciones para la venta:", e);
        }
      }
      
      async function cargarDataParaSelector(url, selectId, valueField, textField) {
        try {
          const data = await fetchAPI(url);
          const select = document.getElementById(selectId);
          const currentValue = select.value;
          let optionsHtml = selectId === 'ventaCliente' ? '<option value="">Público General</option>' : '<option value="">-- Selecciona un producto --</option>';
          data.forEach(item => {
            let text = typeof textField === 'function' ? textField(item) : item[textField];
            optionsHtml += `<option value="${item[valueField]}" data-precio="${item.precio || 0}">${text}</option>`;
          });
          select.innerHTML = optionsHtml;
          select.value = currentValue;
        } catch(e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarDataParaBotones(url, containerId) {
          try{
              const data = await fetchAPI(url);
              const container = document.getElementById(containerId);
              container.innerHTML = '';
              data.forEach(item => {
                  const button = document.createElement('button');
                  button.className = 'option-btn';
                  button.textContent = `${item.nombre} - $${item.precio.toFixed(2)}`;
                  button.dataset.id = item.id;
                  button.dataset.precio = item.precio;
                  button.dataset.nombre = item.nombre;
                  button.onclick = () => {
                      button.classList.toggle('selected');
                  };
                  container.appendChild(button);
              });
          } catch(e) { /* Error manejado en fetchAPI */ }
      }
      
      function resetearFormularioItem() {
          document.getElementById('ventaProducto').value = '';
          document.getElementById('ventaCantidad').value = '1';
          document.getElementById('ventaNota').value = '';
          document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
          document.querySelectorAll(".collapsible.active").forEach(c => {
              c.classList.remove('active');
              c.nextElementSibling.style.maxHeight = '0px';
          });
      }

      function agregarAVenta() {
        const productoSelect = document.getElementById('ventaProducto');
        if (!productoSelect.value) { alert('Selecciona un producto'); return; }
        const productoNombre = productoSelect.options[productoSelect.selectedIndex].text.split(' - ')[0];
        const cantidad = parseInt(document.getElementById('ventaCantidad').value) || 1;
        const toppings = Array.from(document.querySelectorAll('#toppings-container .option-btn.selected')).map(btn => ({ nombre: btn.dataset.nombre }));
        const jarabes = Array.from(document.querySelectorAll('#jarabes-container .option-btn.selected')).map(btn => ({ nombre: btn.dataset.nombre }));
        const nota = document.getElementById('ventaNota').value.trim();
        let totalItem = (parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.precio) * cantidad) + 
                        Array.from(document.querySelectorAll('.option-btn.selected')).reduce((acc, btn) => acc + parseFloat(btn.dataset.precio), 0);
        
        ventaActual.push({ productoNombre, cantidad, toppings, jarabes, nota, total: totalItem });
        
        if (ventaActual.length > 0) {
            document.getElementById('ventaCliente').disabled = true;
        }

        mostrarVentaActual();
        resetearFormularioItem();
      }

      async function registrarVenta(estatus) {
        if (procesandoVenta) return; 
        procesandoVenta = true;
        const btnPagado = document.getElementById('btnRegistrarPagado');
        const btnPendiente = document.getElementById('btnRegistrarPendiente');
        const btnActualizar = document.getElementById('btnActualizarVenta');
        [btnPagado, btnPendiente, btnActualizar].forEach(btn => btn.disabled = true);
        
        try {
            if (ventaActual.length === 0) {
                alert('Agrega al menos un producto a la venta');
                return;
            }
            const clienteSelect = document.getElementById('ventaCliente');
            const costoDomicilio = document.getElementById('checkDomicilio').checked ? parseFloat(document.getElementById('costoDomicilio').value || 0) : 0;
            const subtotal = ventaActual.reduce((a, i) => a + i.total, 0);
            
            const idVentaEditada = document.getElementById('idVenta').value;
            const ventaOriginal = idVentaEditada ? ventasEnMemoria.find(v => v.id === idVentaEditada) : {};

            const ventaData = { 
                fecha: new Date().toISOString(), 
                clienteId: clienteSelect.value || null,
                clienteNombre: clienteSelect.value ? clienteSelect.options[clienteSelect.selectedIndex].text : 'Público General',
                items: ventaActual, 
                subtotal: subtotal, 
                costoDomicilio: costoDomicilio, 
                total: subtotal + costoDomicilio,
                metodoPago: document.getElementById('metodoPago').value,
                estatus: estatus || ventaOriginal.estatus
            };
            
            const url = idVentaEditada ? `/api/ventas/${idVentaEditada}` : '/api/ventas';
            const metodo = idVentaEditada ? 'PUT' : 'POST';

            const ventaGuardada = await fetchAPI(url, { method: metodo, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ventaData) });
            alert(`Venta ${idVentaEditada ? 'actualizada' : 'guardada como ' + estatus} con éxito`);
            document.getElementById('ticket').textContent = generarTextoTicket(ventaGuardada);
            resetearFormularioCompleto();
            await cargarVentasHistorial();
        } catch (e) {
            alert(`Error: ${e.message}`);
        } finally {
            procesandoVenta = false;
            [btnPagado, btnPendiente, btnActualizar].forEach(btn => btn.disabled = false);
        }
      }

      function mostrarVentaActual() {
        const lista = document.getElementById('listaVentaActual');
        lista.innerHTML = '';
        ventaActual.forEach((item, index) => {
          const li = document.createElement('li');
          const itemInfo = document.createElement('div');
          itemInfo.innerHTML = `<span>${item.productoNombre} x${item.cantidad} - $${item.total.toFixed(2)}</span>`;
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'X';
          btnEliminar.className = 'btn-eliminar-item';
          btnEliminar.onclick = () => { 
            ventaActual.splice(index, 1); 
            if (ventaActual.length === 0 && !document.getElementById('idVenta').value) {
                document.getElementById('ventaCliente').disabled = false;
            }
            mostrarVentaActual(); 
          };
          itemInfo.appendChild(btnEliminar);
          li.appendChild(itemInfo);
          if (item.nota) {
            const notaDiv = document.createElement('div');
            notaDiv.textContent = `Nota: ${item.nota}`;
            li.appendChild(notaDiv);
          }
          lista.appendChild(li);
        });
        actualizarTotalVenta();
      }

      function actualizarTotalVenta() {
        const subtotalVenta = ventaActual.reduce((acc, item) => acc + item.total, 0);
        const costoDomicilio = document.getElementById('checkDomicilio').checked ? parseFloat(document.getElementById('costoDomicilio').value || 0) : 0;
        const totalFinal = subtotalVenta + costoDomicilio;
        document.getElementById('totalVenta').textContent = `Total Venta: $${totalFinal.toFixed(2)}`;
      }

      function resetearFormularioCompleto() {
        ventaActual = [];
        document.getElementById('formVenta').reset();
        document.getElementById('ventaCliente').disabled = false;
        document.getElementById('idVenta').value = '';
        document.getElementById('checkDomicilio').checked = false;
        document.getElementById('costoDomicilio').style.display = 'none';
        document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
        document.querySelectorAll(".collapsible.active").forEach(c => {
            c.classList.remove('active');
            c.nextElementSibling.style.maxHeight = '0px';
        });
        document.getElementById('metodoPago').value = "Efectivo";
        document.getElementById('botones-finalizar-venta').style.display = 'flex';
        document.getElementById('btnActualizarVenta').style.display = 'none';
        mostrarVentaActual();
      }

      function generarTextoTicket(venta) {
        let texto = `--- Ticket Dulces Amigas ---\nFecha: ${new Date(venta.fecha).toLocaleString()}\nCliente: ${venta.clienteNombre}\nAtendido por: ${venta.vendedorUsername}\n\n`;
        venta.items.forEach((n, a) => {
          texto += `${a + 1}. ${n.productoNombre} x${n.cantidad}\n`;
          if (n.toppings && n.toppings.length) texto += `   + Toppings: ${n.toppings.map(e => e.nombre).join(", ")}\n`;
          if (n.jarabes && n.jarabes.length) texto += `   + Jarabes: ${n.jarabes.map(e => e.nombre).join(", ")}\n`;
          if (n.nota) texto += `   * Nota: ${n.nota}\n`;
          texto += `   Subtotal Item: $${n.total.toFixed(2)}\n\n`;
        });
        texto += `---------------------------\nSubtotal: $${venta.subtotal.toFixed(2)}\n`;
        if (venta.costoDomicilio > 0) texto += `Domicilio: $${venta.costoDomicilio.toFixed(2)}\n`;
        texto += `TOTAL: $${venta.total.toFixed(2)}\n`;
        texto += `Método de pago: ${venta.metodoPago || 'N/A'}\n`;
        texto += `Estatus: ${venta.estatus || 'N/A'}\n---------------------------\n¡Gracias por tu compra!`;
        return texto;
      }
      
      async function cargarUsuarios() {
          try {
              const usuarios = await fetchAPI('/api/usuarios');
              renderizarLista(usuarios, 'Usuario', ['username', 'role']);
          } catch (e) { renderizarLista([], 'Usuario', ['username', 'role']); }
      }

      function limpiarFormularioUsuario() {
          document.getElementById('formUsuario').reset();
          document.getElementById('idUsuario').value = '';
          document.getElementById('permisos-container').style.display = 'block';
          document.getElementById('passwordUsuario').setAttribute('placeholder', 'Contraseña');
          document.getElementById('formUsuario').querySelector('button[type="submit"]').textContent = 'Crear Usuario';
      }

      function cargarUsuarioEnForm(usuario) {
          limpiarFormularioUsuario();
          document.getElementById('idUsuario').value = usuario.id;
          document.getElementById('usernameUsuario').value = usuario.username;
          document.getElementById('roleUsuario').value = usuario.role;
          document.getElementById('passwordUsuario').setAttribute('placeholder', 'Dejar en blanco para no cambiar');
          document.getElementById('formUsuario').querySelector('button[type="submit"]').textContent = 'Actualizar Usuario';
          
          const permisosContainer = document.getElementById('permisos-container');
          const permisosCheckboxes = permisosContainer.querySelectorAll('input[type="checkbox"]');
          
          permisosContainer.style.display = 'block';
          if (usuario.permissions) {
              permisosCheckboxes.forEach(cb => {
                  cb.checked = usuario.permissions[cb.value] || false;
              });
          }
      }

      async function guardarUsuario(e) {
        e.preventDefault();
        const id = document.getElementById('idUsuario').value;
        const username = document.getElementById('usernameUsuario').value;
        const password = document.getElementById('passwordUsuario').value;
        const role = document.getElementById('roleUsuario').value;
        
        const permissions = {};
        document.querySelectorAll('#permisos-container input[type="checkbox"]').forEach(cb => {
            permissions[cb.value] = cb.checked;
        });

        if (!username || !role) {
            alert('Nombre de usuario y rol son obligatorios.');
            return;
        }
        if (!id && !password) {
            alert('La contraseña es obligatoria para nuevos usuarios.');
            return;
        }

        const body = { username, role, permissions };
        if (password) {
            body.password = password;
        }

        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/usuarios/${id}` : '/api/usuarios';

        try {
            await fetchAPI(url, { method: metodo, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            alert(`Usuario ${id ? 'actualizado' : 'creado'} con éxito.`);
            limpiarFormularioUsuario();
            await cargarUsuarios();
            
            const token = localStorage.getItem('token');
            const payload = JSON.parse(atob(token.split('.')[1]));
            if (id === payload.id) {
              alert("Tus propios permisos han sido actualizados. Se cerrará la sesión para aplicar los cambios.");
              showLogin();
            }
        } catch(err) {
            alert(`Error: ${err.message}`);
        }
      }

      async function marcarComoPagado(ventaId) {
          const metodoPagoFinal = prompt("Por favor, introduce el método de pago final (Efectivo, Tarjeta, Transferencia):", "Efectivo");
          if (metodoPagoFinal && metodoPagoFinal.trim() !== "") {
              if (confirm(`¿Marcar esta orden como "Pagado" con el método "${metodoPagoFinal}"?`)) {
                  try {
                      await fetchAPI(`/api/ventas/${ventaId}`, {
                          method: 'PUT',
                          body: JSON.stringify({
                              estatus: "Pagado",
                              metodoPago: metodoPagoFinal.trim()
                          })
                      });
                      alert("¡Venta actualizada a 'Pagado'!");
                      cargarVentasHistorial();
                  } catch (error) {
                      alert(`Error al actualizar la venta: ${error.message}`);
                  }
              }
          }
      }
      
      async function cambiarEstatus(ventaId, estatusActual) {
        if (!estatusActual || estatusActual === "N/A") {
          alert("No se puede cambiar el estatus de un registro antiguo.");
          return;
        }
        const nuevoEstatus = estatusActual === 'Pagado' ? 'Pendiente de Pago' : 'Pagado';
        if (confirm(`¿Deseas cambiar el estatus de esta venta a "${nuevoEstatus}"?`)) {
          try {
            await fetchAPI(`/api/ventas/${ventaId}`, {
                method: 'PUT',
                body: JSON.stringify({ estatus: nuevoEstatus })
            });
            alert("¡Estatus de la venta actualizado!");
            cargarVentasHistorial();
          } catch (error) {
            alert(`Error al actualizar el estatus: ${error.message}`);
          }
        }
      }

      function reimprimirTicket(ventaId) {
          const venta = ventasEnMemoria.find(v => v.id === ventaId);
          if (venta) {
              document.getElementById('ticket').textContent = generarTextoTicket(venta);
              mostrarSeccion('registrar-venta');
              alert("Ticket cargado. Ahora puedes enviarlo por WhatsApp o generar el PDF.");
          } else {
              alert("No se encontró la venta para reimprimir el ticket.");
          }
      }

      function editarVenta(ventaId) {
        const venta = ventasEnMemoria.find(v => v.id === ventaId);
        if (venta) {
          resetearFormularioCompleto();
          document.getElementById('idVenta').value = venta.id;
          document.getElementById('ventaCliente').value = venta.clienteId || '';
          ventaActual = venta.items.map(item => ({...item}));
          mostrarVentaActual();

          document.getElementById('ventaCliente').disabled = true;
          document.getElementById('botones-finalizar-venta').style.display = 'none';
          document.getElementById('btnActualizarVenta').style.display = 'block';

          mostrarSeccion('registrar-venta');
        } else {
            alert("No se encontró la venta para editar.");
        }
      }

      async function cargarVentasHistorial() {
        try {
          ventasEnMemoria = await fetchAPI('/api/ventas');
          const periodo = document.querySelector('#botones-periodo button.active').dataset.periodo;
          const clienteId = document.getElementById('filtroCliente').value;
          const usuarioId = document.getElementById('filtroUsuario').value;
          const estatus = document.getElementById('filtroEstatus').value;
          
          const ahora = new Date();
          let fechaInicio;
          if (periodo === 'mes') { fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1); }
          else if (periodo === 'semana') { fechaInicio = new Date(ahora); fechaInicio.setDate(ahora.getDate() - ahora.getDay() + (ahora.getDay() === 0 ? -6 : 1)); }
          else { fechaInicio = new Date(ahora); }
          fechaInicio.setHours(0, 0, 0, 0);

          let ventasFiltradas = ventasEnMemoria.filter(venta => new Date(venta.fecha) >= fechaInicio);
          if (clienteId) { ventasFiltradas = ventasFiltradas.filter(venta => venta.clienteId == clienteId); }
          if (usuarioId) { ventasFiltradas = ventasFiltradas.filter(venta => venta.vendedorId == usuarioId); }
          
          if (estatus) {
              ventasFiltradas = ventasFiltradas.filter(venta => venta.estatus === estatus);
          }

          const tbody = document.getElementById('tablaVentasBody');
          tbody.innerHTML = '';
          ventasFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(venta => {
            const tr = document.createElement('tr');
            
            const estatusActual = venta.estatus || 'N/A';
            let estatusClass = 'status-na';
            if(estatusActual === 'Pagado') estatusClass = 'status-pagado';
            if(estatusActual === 'Pendiente de Pago') estatusClass = 'status-pendiente';
            
            let accionesHTML = `
              <button class="btn-editar-venta" data-id="${venta.id}" title="Editar Venta">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
              </button>
              <button class="btn-reimprimir" data-id="${venta.id}" title="Reimprimir Ticket">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h.01M15 12h.01M10.5 16.5h3m-3.75-3.75a1.875 1.875 0 00-3.75 0v.75c0 1.036.84 1.875 1.875 1.875h3.75c1.036 0 1.875-.84 1.875-1.875v-.75a1.875 1.875 0 00-3.75 0zM12 1.5v4.5m0 0l-3-3m3 3l3-3M3.75 6.75h16.5M3.75 10.5h16.5M3.75 14.25h16.5M3.75 18h16.5" /></svg>
              </button>
              <button class="btn-eliminar-venta" data-id="${venta.id}">X</button>
            `;
            if (estatusActual === 'Pendiente de Pago') {
                accionesHTML = `<button class="btn-marcar-pagado" data-id="${venta.id}">Marcar como Pagado</button>` + accionesHTML;
            }

            tr.innerHTML = `
              <td>${venta.id.slice(-6)}</td>
              <td>${venta.vendedorUsername}</td>
              <td>${venta.clienteNombre}</td>
              <td>$${venta.total.toFixed(2)}</td>
              <td>${venta.metodoPago || 'N/A'}</td>
              <td>
                <span class="status-badge ${estatusClass}">${estatusActual}</span>
                <button class="btn-cambiar-estatus" data-id="${venta.id}" data-estatus="${estatusActual}" title="Cambiar Estatus">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                </button>
              </td>
              <td>${new Date(venta.fecha).toLocaleString()}</td>
              <td>${accionesHTML}</td>
            `;
            tbody.appendChild(tr);
          });
          
          document.querySelectorAll('.btn-eliminar-venta').forEach(btn => btn.addEventListener('click', () => eliminarItem(btn.dataset.id, 'Venta')));
          document.querySelectorAll('.btn-marcar-pagado').forEach(btn => btn.addEventListener('click', () => marcarComoPagado(btn.dataset.id)));
          document.querySelectorAll('.btn-reimprimir').forEach(btn => btn.addEventListener('click', () => reimprimirTicket(btn.dataset.id)));
          document.querySelectorAll('.btn-editar-venta').forEach(btn => btn.addEventListener('click', () => editarVenta(btn.dataset.id)));
          document.querySelectorAll('.btn-cambiar-estatus').forEach(btn => btn.addEventListener('click', () => cambiarEstatus(btn.dataset.id, btn.dataset.estatus)));

          const totalPeriodo = ventasFiltradas.reduce((acc, venta) => acc + venta.total, 0);
          document.getElementById('totalPeriodoHistorial').textContent = `Total del Período Filtrado: $${totalPeriodo.toFixed(2)}`;
          prepararDatosParaGraficas(ventasFiltradas);
          generarResumen(ventasFiltradas);
        } catch (e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarUsuariosParaFiltro() {
        try {
          const data = await fetchAPI('/api/usuarios');
          const select = document.getElementById('filtroUsuario');
          select.innerHTML = '<option value="">Todos los Vendedores</option>';
          data.forEach(user => select.innerHTML += `<option value="${user.id}">${user.username}</option>`);
        } catch (e) { /* Error manejado en fetchAPI */ }
      }

      async function cargarClientesParaFiltro() {
        try {
          const data = await fetchAPI('/api/clientes');
          const select = document.getElementById('filtroCliente');
          select.innerHTML = '<option value="">Todos los Clientes</option>';
          data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`);
        } catch (e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarPapelera() {
        try {
            const [productos, toppings, jarabes, clientes, usuarios, ventas] = await Promise.all([
                fetchAPI('/api/productos/papelera'), fetchAPI('/api/toppings/papelera'),
                fetchAPI('/api/jarabes/papelera'), fetchAPI('/api/clientes/papelera'),
                fetchAPI('/api/usuarios/papelera'), fetchAPI('/api/ventas/papelera'),
            ]);
            renderizarPapelera(productos, 'Producto');
            renderizarPapelera(toppings, 'Topping');
            renderizarPapelera(jarabes, 'Jarabe');
            renderizarPapelera(clientes, 'Cliente');
            renderizarPapelera(usuarios, 'Usuario');
            renderizarPapeleraVentas(ventas);
        } catch (error) {
            alert("Error al cargar la papelera: " + error.message);
        }
      }

      function renderizarPapelera(items, tipo) {
        const lista = document.getElementById(`papelera-${tipo.toLowerCase()}s`);
        if(!lista) return;
        lista.innerHTML = '';
        items.forEach(item => {
          const li = document.createElement('li');
          const texto = document.createElement('span');
          texto.textContent = item.nombre || item.username;
          
          const divBotones = document.createElement('div');
          const btnRestaurar = document.createElement('button');
          btnRestaurar.textContent = 'Restaurar';
          btnRestaurar.className = 'btn-restaurar';
          btnRestaurar.onclick = () => restaurarItem(item.id, tipo);

          const btnEliminarPerm = document.createElement('button');
          btnEliminarPerm.textContent = 'Eliminar Permanente';
          btnEliminarPerm.className = 'btn-eliminar-perm';
          btnEliminarPerm.onclick = () => eliminarPermanentemente(item.id, tipo);

          divBotones.appendChild(btnRestaurar);
          divBotones.appendChild(btnEliminarPerm);
          li.appendChild(texto);
          li.appendChild(divBotones);
          lista.appendChild(li);
        });
      }

      function renderizarPapeleraVentas(items) {
          const tbody = document.getElementById('papelera-ventas');
          tbody.innerHTML = '';
          items.forEach(item => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                  <td>${item.clienteNombre || 'N/A'}</td>
                  <td>${new Date(item.fecha).toLocaleString()}</td>
                  <td>$${item.total.toFixed(2)}</td>
                  <td>
                      <button class="btn-restaurar" data-id="${item.id}" data-tipo="Venta">Restaurar</button>
                      <button class="btn-eliminar-perm" data-id="${item.id}" data-tipo="Venta">Eliminar Permanente</button>
                  </td>
              `;
              tbody.appendChild(tr);
          });
          tbody.querySelectorAll('.btn-restaurar').forEach(btn => btn.addEventListener('click', (e) => restaurarItem(e.target.dataset.id, e.target.dataset.tipo)));
          tbody.querySelectorAll('.btn-eliminar-perm').forEach(btn => btn.addEventListener('click', (e) => eliminarPermanentemente(e.target.dataset.id, e.target.dataset.tipo)));
      }

      async function restaurarItem(id, tipo) {
        if (confirm(`¿Restaurar este ${tipo.toLowerCase()}? Volverá a la lista principal.`)) {
          try {
            await fetchAPI(`/api/${tipo.toLowerCase()}s/${id}/restaurar`, { method: 'PUT' });
            cargarPapelera();
          } catch (err) { alert(`Error: ${err.message}`); }
        }
      }

      async function eliminarPermanentemente(id, tipo) {
        if (confirm(`¡ADVERTENCIA! Esta acción es irreversible. ¿Eliminar permanentemente este ${tipo.toLowerCase()}?`)) {
          try {
            await fetchAPI(`/api/${tipo.toLowerCase()}s/${id}/permanente`, { method: 'DELETE' });
            cargarPapelera();
          } catch (err) { alert(`Error: ${err.message}`); }
        }
      }

      function prepararDatosParaGraficas(ventas) {
        const formatoFecha = { weekday: 'short', day: 'numeric' };
        let ventasPorDia = {};
        ventas.forEach(venta => {
          const clave = new Date(venta.fecha).toLocaleDateString('es-ES', formatoFecha);
          ventasPorDia[clave] = (ventasPorDia[clave] || 0) + venta.total;
        });
        actualizarGraficaBarras(Object.keys(ventasPorDia).reverse(), Object.values(ventasPorDia).reverse());
        let productosVendidos = {};
        ventas.forEach(venta => {
            venta.items.forEach(item => {
                productosVendidos[item.productoNombre] = (productosVendidos[item.productoNombre] || 0) + item.cantidad;
            });
        });
        actualizarGraficaCircular(Object.keys(productosVendidos), Object.values(productosVendidos));
      }

      function actualizarGraficaBarras(labels, data) {
        if (miGraficaDeVentas) { miGraficaDeVentas.destroy(); }
        const ctx = document.getElementById('graficaVentas')?.getContext('2d');
        if (!ctx) return;
        miGraficaDeVentas = new Chart(ctx, { 
            type: 'bar', 
            data: { labels, datasets: [{ label: `Ventas Totales`, data, backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] }, 
            options: { responsive: true, maintainAspectRatio: true, aspectRatio: 2, scales: { y: { beginAtZero: true } } } 
        });
      }

      function actualizarGraficaCircular(labels, data) {
        if (miGraficaDeProductos) { miGraficaDeProductos.destroy(); }
        const ctx = document.getElementById('graficaProductos')?.getContext('2d');
        if (!ctx) return;
        miGraficaDeProductos = new Chart(ctx, { 
            type: 'doughnut', 
            data: { labels, datasets: [{ label: 'Productos Vendidos', data, backgroundColor: ['#4f46e5', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff'], hoverOffset: 4 }] }, 
            options: { responsive: true, maintainAspectRatio: true, aspectRatio: 1.5, } 
        });
      }

      function generarResumen(ventas) {
          const resumenProductos = {}, resumenToppings = {}, resumenJarabes = {};
          ventas.forEach(venta => {
              venta.items.forEach(item => {
                  resumenProductos[item.productoNombre] = (resumenProductos[item.productoNombre] || 0) + item.cantidad;
                  if (item.toppings) item.toppings.forEach(t => { resumenToppings[t.nombre] = (resumenToppings[t.nombre] || 0) + 1; });
                  if (item.jarabes) item.jarabes.forEach(j => { resumenJarabes[j.nombre] = (resumenJarabes[j.nombre] || 0) + 1; });
              });
          });
          let textoResumen = "--- RESUMEN DE PRODUCTOS ---\n" + Object.entries(resumenProductos).map(([n, c]) => `${n.padEnd(20, ' ')}: ${c}`).join('\n');
          textoResumen += "\n\n--- RESUMEN DE TOPPINGS ---\n" + Object.entries(resumenToppings).map(([n, c]) => `${n.padEnd(20, ' ')}: ${c}`).join('\n');
          textoResumen += "\n\n--- RESUMEN DE JARABES ---\n" + Object.entries(resumenJarabes).map(([n, c]) => `${n.padEnd(20, ' ')}: ${c}`).join('\n');
          document.getElementById('resumen-ventas').textContent = textoResumen;
      }
      
      function generarReportePDF() {
          const textoResumen = document.getElementById('resumen-ventas').textContent;
          const totalTexto = document.getElementById('totalPeriodoHistorial').textContent;
          const filtros = `Período: ${document.querySelector('#botones-periodo button.active').textContent}, Cliente: ${document.getElementById('filtroCliente').options[document.getElementById('filtroCliente').selectedIndex].text}, Vendedor: ${document.getElementById('filtroUsuario').options[document.getElementById('filtroUsuario').selectedIndex].text}`;
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF();
          pdf.setFontSize(18);
          pdf.setFont('helvetica', 'bold');
          pdf.text("Reporte de Ventas - Dulces Amigas", 105, 20, { align: 'center' });
          pdf.setFontSize(10);
          pdf.setFont('helvetica', 'normal');
          pdf.text(`Filtros Aplicados: ${filtros}`, 10, 35);
          pdf.text(`Fecha del Reporte: ${new Date().toLocaleString()}`, 10, 40);
          pdf.setFont('courier', 'normal');
          pdf.setFontSize(11);
          pdf.text(textoResumen, 10, 55);
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(14);
          pdf.text(totalTexto, 105, 280, { align: 'center' });
          pdf.save("reporte-ventas.pdf");
      }

      function setupEventListeners() {
        document.getElementById('btnRegistrarPagado').addEventListener('click', () => registrarVenta('Pagado'));
        document.getElementById('btnRegistrarPendiente').addEventListener('click', () => registrarVenta('Pendiente de Pago'));
        document.getElementById('btnActualizarVenta').addEventListener('click', () => registrarVenta(null));
        document.getElementById('filtroEstatus').addEventListener('change', cargarVentasHistorial);
        document.querySelectorAll('nav a').forEach(b => b.addEventListener('click', (e) => {
            e.preventDefault();
            mostrarSeccion(b.dataset.seccion);
        }));
        mainContent.addEventListener('click', (e) => {
          if (nav.classList.contains('nav-open') && window.innerWidth < 992) {
            if (!e.target.closest('.sidebar') && !e.target.closest('#menu-toggle')) {
              nav.classList.remove('nav-open');
            }
          }
        });
        togglePassword.addEventListener('click', () => {
          const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
          passwordInput.setAttribute('type', type);
          eyeOpen.style.display = type === 'password' ? 'block' : 'none';
          eyeClosed.style.display = type === 'text' ? 'block' : 'none';
        });
        document.getElementById('formProducto').addEventListener('submit', (e) => guardarItem(e, 'Producto'));
        document.getElementById('formTopping').addEventListener('submit', (e) => guardarItem(e, 'Topping'));
        document.getElementById('formJarabe').addEventListener('submit', (e) => guardarItem(e, 'Jarabe'));
        document.getElementById('formCliente').addEventListener('submit', (e) => guardarItem(e, 'Cliente'));
        document.getElementById('formUsuario').addEventListener('submit', (e) => guardarUsuario(e));
        document.getElementById('roleUsuario').addEventListener('change', () => {
            document.getElementById('permisos-container').style.display = 'block';
        });
        document.getElementById('btnLimpiarFormUsuario').addEventListener('click', limpiarFormularioUsuario);
        document.getElementById('btnAgregarVenta').addEventListener('click', agregarAVenta);
        document.getElementById('checkDomicilio').addEventListener('change', (e) => {
          const costoInput = document.getElementById('costoDomicilio');
          costoInput.style.display = e.target.checked ? 'inline-block' : 'none';
          if (e.target.checked) { costoInput.value = COSTO_DOMICILIO_PREDET.toFixed(2); }
          else { costoInput.value = ''; }
          actualizarTotalVenta();
        });
        document.getElementById('costoDomicilio').addEventListener('input', actualizarTotalVenta);
        document.querySelectorAll('#botones-periodo button').forEach(button => {
          button.addEventListener('click', () => {
            document.querySelector('#botones-periodo button.active').classList.remove('active');
            button.classList.add('active');
            cargarVentasHistorial();
          });
        });
        document.getElementById('filtroCliente').addEventListener('change', cargarVentasHistorial);
        document.getElementById('filtroUsuario').addEventListener('change', cargarVentasHistorial);
        document.getElementById('btnGenerarReporte').addEventListener('click', generarReportePDF);
        document.getElementById('btnGenerarPDF').addEventListener('click', () => {
          const ticketElement = document.getElementById('ticket');
          if (ticketElement.textContent.trim() === '') { alert('Primero debe registrar una venta para generar un ticket.'); return; }
          html2canvas(ticketElement).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF();
            const imgProps= pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save("ticket-dulces-amigas.pdf");
          });
        });
        document.getElementById('btnEnviarWhatsapp').addEventListener('click', () => {
          const textoTicket = document.getElementById('ticket').textContent;
          if (textoTicket.trim() === '') { alert('No hay un ticket generado para enviar.'); return; }
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(textoTicket)}`, '_blank');
        });
        themeSwitch.addEventListener('change', () => {
            if (themeSwitch.checked) {
                applyTheme('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                applyTheme('light');
                localStorage.setItem('theme', 'light');
            }
        });
      }

      // INICIO DE LA APLICACIÓN
      await loadPublicConfig();

      if (localStorage.getItem('token')) {
        await showApp();
      } else {
        showLogin();
      }
    });
  </script>
</body>
</html>