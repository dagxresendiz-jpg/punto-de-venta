<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dulces Amigas - Punto de Venta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { visibility: hidden; }
    :root {
      --primary-color: #4f46e5; --accent-color: #FF85A2; --primary-hover: #4338ca; 
      --danger-color: #ef4444; --danger-hover: #dc2626; --success-color: #22c55e; 
      --success-hover: #16a34a; --info-color: #38bdf8; --info-hover: #0ea5e9;
      --warning-color: #f59e0b; --warning-hover: #d97706;
      --background-color: #f8fafc; --card-background: #ffffff; --text-color-dark: #1e293b; 
      --text-color-light: #64748b; --border-color: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --form-control-bg: #ffffff; --collapsible-bg: #f1f5f9; --table-header-bg: #f8fafc;
      --secondary-button-bg: #f1f5f9; --secondary-button-text: #1e293b; --secondary-button-hover-bg: #e2e8f0;
    }
    body.dark-mode {
      --background-color: #1e293b; --card-background: #334155; --text-color-dark: #f1f5f9;
      --text-color-light: #94a3b8; --border-color: #475569;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2);
      --form-control-bg: #475569; --collapsible-bg: #475569; --table-header-bg: #1e293b;
      --secondary-button-bg: #475569; --secondary-button-text: #f1f5f9; --secondary-button-hover-bg: #525f75;
    }
    .product-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
    .product-item > div { display: flex; align-items: center; gap: 1rem; }
    .agotado-switch { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8em; }
    .agotado-switch .slider { width: 40px; height: 20px; }
    .agotado-switch .slider:before { height: 14px; width: 14px; bottom: 3px; }
    input:checked + .slider:before { transform: translateX(18px); }
    .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .kanban-column { background-color: var(--background-color); border-radius: 8px; padding: 1rem; }
    .kanban-column h3 { text-align: center; margin-bottom: 1rem; color: var(--text-color-dark); }
    .pedido-card { background: var(--card-background); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: var(--shadow); }
    .pedido-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .pedido-card-header h4 { margin: 0; }
    .pedido-card-header span { font-size: 0.8em; color: var(--text-color-light); }
    .pedido-card-body ul { list-style: none; padding-left: 1rem; margin: 0.5rem 0; }
    .pedido-card-body li { font-size: 0.9em; }
    .pedido-card-footer { border-top: 1px solid var(--border-color); padding-top: 0.75rem; margin-top: 0.75rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .pedido-card-footer .total { font-weight: 600; }
    .pedido-actions { display: flex; gap: 0.5rem; flex-wrap: wrap;}
    .pedido-actions button { padding: 0.25rem 0.5rem; font-size: 0.8em; margin-left: 0; }
    .btn-whatsapp { background-color: #25D366; color: white; }
    .btn-preparar { background-color: var(--info-color); color: white; }
    .btn-listo { background-color: var(--success-color); color: white; }
    .btn-convertir { background-color: var(--primary-color); color: white; }
    .btn-cancelar { background-color: var(--danger-color); color: white; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color-dark); -webkit-font-smoothing: antialiased; }
    .app-wrapper { display: flex; min-height: 100vh; }
    .sidebar { width: 250px; background-color: var(--card-background); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem 1rem; transition: transform 0.3s ease; }
    .sidebar-header { text-align: center; margin-bottom: 2rem; }
    #app-logo { max-width: 180px; max-height: 80px; cursor: pointer; transition: transform 0.2s ease; }
    #app-logo:hover { transform: scale(1.05); }
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px; text-decoration: none; color: var(--text-color-light); font-weight: 500; transition: all 0.2s ease; cursor: pointer; }
    .nav-link:hover { background-color: var(--background-color); color: var(--primary-color); }
    .nav-link.active-link { background-color: var(--primary-color); color: white; }
    .nav-link svg { width: 20px; height: 20px; stroke-width: 2; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    #logout-button { width: 100%; justify-content: center; background-color: var(--danger-color); color: white; border: none; font-weight: 500; }
    #logout-button:hover { background-color: var(--danger-hover); }
    .main-content { flex: 1; display: flex; flex-direction: column; }
    .main-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); }
    .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color-dark); }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    main { padding: 2rem; overflow-y: auto; }
    section { display: none; }
    section.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background-color: var(--card-background); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .card-header h2, .card-header h3 { font-size: 1.25rem; font-weight: 600; border: none; padding: 0; margin: 0; }
    .card h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-weight: 600; }
    .card h3:first-child { margin-top: 0; }
    .export-buttons button { padding: 0.4rem; font-size: 0.8em; line-height: 1; display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; }
    .export-buttons button svg { width: 18px; height: 18px; }
    form label { display: block; margin-bottom: 0.5rem; font-weight: 500; text-align: left; color: var(--text-color-dark); }
    form input, form select { background-color: var(--form-control-bg); color: var(--text-color-dark); display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; transition: box-shadow 0.2s, border-color 0.2s; }
    form input::placeholder { color: var(--text-color-light); opacity: 0.8; }
    form input:focus, form select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px #c7d2fe; outline: none; }
    form select:disabled { background-color: #475569; cursor: not-allowed; opacity: 0.7; }
    .password-wrapper { position: relative; display: flex; align-items: center; }
    .password-wrapper input { padding-right: 3rem; }
    #toggle-password { position: absolute; right: 1rem; top: 0.75rem; cursor: pointer; color: var(--text-color-light); }
    #toggle-password svg { width: 20px; height: 20px; }
    button { cursor: pointer; border-radius: 8px; border: none; padding: 0.75rem 1.25rem; font-weight: 600; transition: all 0.2s; }
    button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    button[type="submit"], #btnAgregarVenta { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover, #btnAgregarVenta:hover { background-color: var(--primary-hover); }
    .btn-secondary { background-color: var(--secondary-button-bg); color: var(--secondary-button-text); }
    .btn-secondary:hover { background-color: var(--secondary-button-hover-bg); }
    .btn-eliminar-item, .btn-eliminar-venta { background-color: var(--danger-color); color: white; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
    #listaVentaActual { margin-bottom: 1rem; }
    #listaVentaActual li { flex-direction: column; align-items: stretch; }
    #opcion-domicilio { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
    #opcion-domicilio > div { display: flex; align-items: center; gap: 0.5rem; }
    #opcion-domicilio input[type="checkbox"] { width: auto; margin: 0; }
    #opcion-domicilio input[type="number"] { width: 100px; margin: 0; padding: 0.5rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--table-header-bg); font-weight: 600; color: var(--text-color-light); }
    #login-container { max-width: 400px; margin: 15vh auto; background: var(--card-background); box-shadow: var(--shadow); border-radius: 12px; }
    .collapsible { background-color: var(--collapsible-bg); color: var(--text-color-dark); }
    .collapsible-wrapper { margin-bottom: 1rem; }
    .collapsible { width: 100%; text-align: left; font-weight: 500; border: 1px solid var(--border-color); border-radius: 8px; }
    .content-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
    .options-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; }
    .option-btn { padding: 0.5rem 1rem; font-weight: 500; background-color: var(--background-color); color: var(--text-color-dark); border: 1px solid var(--border-color); }
    .option-btn.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    #btnGenerarReporte { background-color: var(--info-color); color: white; }
    #btnGenerarPDF { background-color: #E53E3E; color: white; }
    #btnGenerarPDF:hover { background-color: #C53030; }
    #btnEnviarWhatsapp { background-color: #25D366; color: white; }
    #btnEnviarWhatsapp:hover { background-color: #128C7E; }
    .chart-container { position: relative; width: 100%; }
    #totalPeriodoHistorial { font-weight: bold; font-size: 1.3em; text-align: center; margin-bottom: 1.5rem; padding: 1rem; background-color: #22c55e20; color: var(--success-color); border: 1px solid var(--success-color); border-radius: 8px; }
    #filtros-historial { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end; }
    #filtros-historial > div { flex: 1 1 200px; }
    #filtros-historial label { font-size: 0.9em; margin-bottom: 0.5rem; color: var(--text-color-dark); display: block; }
    #botones-periodo { display: flex; gap: 0.5rem; }
    #botones-periodo button { background-color: var(--card-background); color: var(--text-color-light); border: 1px solid var(--border-color); font-weight: 500; padding: 0.75rem 1rem; }
    #botones-periodo button:hover { background-color: var(--secondary-button-hover-bg); }
    #botones-periodo button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    #resumen-ventas { white-space: pre-wrap; word-break: break-word; }
    #botones-finalizar-venta { display: flex; gap: 1rem; }
    #botones-finalizar-venta button { flex: 1; }
    #btnRegistrarPagado { background-color: var(--success-color); color: white; }
    #btnRegistrarPagado:hover { background-color: var(--success-hover); }
    #btnRegistrarPendiente { background-color: var(--info-color); color: white; }
    #btnRegistrarPendiente:hover { background-color: var(--info-hover); }
    .status-badge { padding: 0.2em 0.6em; border-radius: 12px; font-size: 0.8em; font-weight: 600; color: white; text-align: center; display: inline-block; }
    .status-pagado { background-color: #16a34a; }
    .status-pendiente { background-color: #f59e0b; }
    .status-na { background-color: var(--text-color-light); }
    .btn-marcar-pagado { background-color: var(--success-color); color: white; padding: 0.4rem 0.8rem; font-size: 0.8em; margin-right: 0.5rem; }
    .btn-marcar-pagado:hover { background-color: var(--success-hover); }
    .btn-reimprimir, .btn-editar-venta { background-color: var(--primary-color); color: white; padding: 0.4rem; font-size: 0.8em; line-height: 1; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; margin-right: 0.5rem; }
    .btn-reimprimir svg, .btn-editar-venta svg { width: 16px; height: 16px; }
    .btn-cambiar-estatus { background: none; border: none; padding: 0; margin-left: 0.5rem; cursor: pointer; color: var(--text-color-light); }
    .btn-cambiar-estatus:hover { color: var(--primary-color); }
    .btn-cambiar-estatus svg { width: 16px; height: 16px; }
    .btn-restaurar { background-color: var(--success-color); color: white; }
    .btn-eliminar-perm { background-color: var(--danger-color); color: white; }
    .full-width-card { grid-column: 1 / -1; }
    #permisos-container { border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    #permisos-container label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    #permisos-container input[type="checkbox"] { width: auto; margin: 0; }
    .theme-toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; margin-bottom: 0.5rem; }
    .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(24px); }

    @media (max-width: 992px) {
      .menu-toggle { display: block; }
      .sidebar { position: fixed; left: 0; top: 0; bottom: 0; z-index: 1000; transform: translateX(-100%); }
      .sidebar.nav-open { transform: translateX(0); }
      .app-wrapper { display: block; }
      main { padding: 1rem; }
      .card { padding: 1rem; }
      #opcion-domicilio { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
    }
  </style>
  
  <script>
    (function() {
      const token = localStorage.getItem('token');
      const style = document.createElement('style');
      style.setAttribute('data-flicker-guard', 'true');
      if (token) {
        style.textContent = '#login-container { display: none !important; } #app-wrapper { display: flex !important; }';
      } else {
        style.textContent = '#login-container { display: block !important; } #app-wrapper { display: none !important; }';
      }
      document.head.appendChild(style);
    })();
  </script>
</head>
<body>

  <div id="login-container" class="card">
    <div style="text-align: center; margin-bottom: 1.5rem;">
        <img id="login-logo" src="https://via.placeholder.com/180x60.png?text=Cargando..." alt="Logotipo" style="max-width: 180px; max-height: 70px;">
    </div>
    <div class="card-header"><h2 style="text-align: center;">Iniciar Sesión</h2></div>
    <form id="login-form">
      <div><label for="username">Usuario</label><input type="text" id="username" required></div>
      <div>
        <label for="password">Contraseña</label>
        <div class="password-wrapper">
          <input type="password" id="password" required>
          <span id="toggle-password">
              <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
              <svg id="eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
          </span>
        </div>
      </div>
      <button type="submit" style="width:100%;">Entrar</button>
      <p id="login-error"></p>
    </form>
  </div>

  <div id="app-wrapper" style="display:none;">
    <nav class="sidebar">
      <div class="sidebar-header">
        <img id="app-logo" src="https://via.placeholder.com/180x60.png?text=Cargando..." alt="Logotipo">
      </div>
      <div class="sidebar-nav">
        <a class="nav-link" data-seccion="gestion-pedidos" id="btn-pedidos"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375-3.375-3.375m0 0L12.75 14.5m3-3-3.375-3.375" /></svg><span>Pedidos Online</span></a>
        <a class="nav-link" data-seccion="registrar-venta"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-6.967c.124-.467-.202-1.026-.693-1.026H6.118" /></svg><span>Registrar Venta</span></a>
        <a class="nav-link" data-seccion="gestion-completa" id="btn-gestion"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg><span>Gestión</span></a>
        <a class="nav-link" data-seccion="gestion-clientes" id="btn-clientes"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663c.278.472.548.972.786 1.503z" /></svg><span>Clientes</span></a>
        <a class="nav-link" data-seccion="gestion-usuarios" id="btn-usuarios"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962c.57-1.023.994-2.131 1.253-3.284C13.437 11.08 14 9.61 14 8c0-1.61-.563-3.08-1.5-4.216m-4.5 14.15a9.083 9.083 0 01-1.253-3.284C6.563 13.08 6 11.61 6 10c0-1.61.563-3.08 1.5-4.216m0 0a5.012 5.012 0 011.5 0c.828 1.136 1.5 2.606 1.5 4.216 0 1.61-.563-3.08-1.5 4.216m0 0l-2.25 2.25a5.012 5.012 0 01-1.5 0l-2.25-2.25m0 0a5.012 5.012 0 00-1.5 0l-2.25 2.25a5.012 5.012 0 00-1.5 0l-2.25-2.25m0 0a5.012 5.012 0 01-1.5 0l-2.25 2.25" /></svg><span>Usuarios</span></a>
        <a class="nav-link" data-seccion="historial-ventas" id="btn-historial"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m1-1.5l1-1.5m0 0l1 1.5m-2-1.5v-6.375c0-1.125.9-2.025 2-2.025h.5c1.1 0 2 .9 2 2.025v6.375m-4.5-3.375V8.25" /></svg><span>Historial</span></a>
        <a class="nav-link" data-seccion="papelera-reciclaje" id="btn-papelera"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.067-2.09 1.02-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg><span>Papelera</span></a>
      </div>
      <div class="sidebar-footer">
        <div id="customization-container" style="display: none;">
            <div id="customization-controls" style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; color: var(--text-color-light); font-weight: 500;">Personalizar Apariencia</h4>
                <input type="file" id="logo-input" accept="image/*" style="display: none;">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; align-items: center;">
                    <label for="primary-color-picker" style="font-size: 0.9em;">Primario:</label>
                    <input type="color" id="primary-color-picker" style="width: 100%; height: 25px; border: none; background: none; cursor: pointer;">
                    <label for="accent-color-picker" style="font-size: 0.9em;">Acento:</label>
                    <input type="color" id="accent-color-picker" style="width: 100%; height: 25px; border: none; background: none; cursor: pointer;">
                </div>
            </div>
        </div>
        <div class="theme-toggle-container">
            <span>Modo Oscuro</span>
            <label class="theme-switch" for="theme-switch">
                <input type="checkbox" id="theme-switch" />
                <span class="slider"></span>
            </label>
        </div>
        <button id="logout-button">Cerrar Sesión</button>
      </div>
    </nav>
    <div class="main-content">
      <header class="main-header">
        <button class="menu-toggle" id="menu-toggle">&#9776;</button>
        <div class="user-info">
          <span id="welcome-user"></span>
        </div>
      </header>
      <main>
        <section id="gestion-pedidos">
            <div class="card">
                <div class="card-header">
                    <h2>Pedidos Online Recibidos</h2>
                </div>
                <div class="kanban-board">
                    <div class="kanban-column">
                        <h3>Nuevos</h3>
                        <div id="pedidos-recibidos"></div>
                    </div>
                    <div class="kanban-column">
                        <h3>En Preparación</h3>
                        <div id="pedidos-en-preparacion"></div>
                    </div>
                    <div class="kanban-column">
                        <h3>Listos para Entregar</h3>
                        <div id="pedidos-listos"></div>
                    </div>
                </div>
            </div>
        </section>
        <section id="registrar-venta">
            <div class="grid-container">
                <div class="card">
                    <div class="card-header"><h2>Registrar Venta</h2></div>
                    <form id="formVenta" onsubmit="return false;">
                        <input type="hidden" id="idVenta">
                        <label for="ventaCliente">Cliente:</label> <select id="ventaCliente"></select>
                        <label for="ventaProducto">Producto:</label> <select id="ventaProducto" required></select>
                        <label for="ventaCantidad">Cantidad:</label> <input type="number" id="ventaCantidad" min="1" value="1" required />
                        <div class="collapsible-wrapper">
                            <button type="button" class="collapsible">Seleccionar Toppings</button>
                            <div class="content-collapsible"><div class="options-grid" id="toppings-container"></div></div>
                        </div>
                        <div class="collapsible-wrapper">
                            <button type="button" class="collapsible">Seleccionar Jarabes</button>
                            <div class="content-collapsible"><div class="options-grid" id="jarabes-container"></div></div>
                        </div>
                        <div id="opcion-domicilio">
                            <div><input type="checkbox" id="checkDomicilio"><label for="checkDomicilio">Servicio a domicilio</label></div>
                            <input type="number" id="costoDomicilio" step="0.01" placeholder="Costo" style="display: none;">
                        </div>
                        <label for="ventaNota">Nota para este producto (opcional):</label>
                        <input type="text" id="ventaNota" placeholder="Ej: Sin nuez, extra chocolate, etc." />
                        <button id="btnAgregarVenta" type="button">Agregar a Venta Actual</button>
                    </form>
                </div>
                <div>
                    <div class="card">
                        <div class="card-header"><h3>Venta Actual</h3></div>
                        <ul id="listaVentaActual"></ul>
                        <div id="totalVenta" style="font-weight:600; font-size: 1.2rem; margin-top: 1rem; text-align: right;">Total venta actual: $0.00</div>
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border-color);">
                        <label for="metodoPago">Método de Pago:</label>
                        <select id="metodoPago">
                            <option value="Efectivo">Efectivo</option> <option value="Tarjeta">Tarjeta</option> <option value="Transferencia">Transferencia</option>
                        </select>
                        <div id="botones-accion-venta" style="margin-top: 1rem;">
                            <div id="botones-finalizar-venta" class="botones-grupo" style="display: flex; gap: 1rem;">
                                <button id="btnRegistrarPendiente" style="flex: 1;">Guardar Pendiente</button>
                                <button id="btnRegistrarPagado" style="flex: 1;">Cobrar y Finalizar</button>
                            </div>
                            <button id="btnActualizarVenta" style="display:none; width: 100%;" class="btn-secondary">Actualizar Venta</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Ticket</h3></div>
                        <pre id="ticket"></pre>
                        <div style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <button id="btnGenerarPDF" style="flex:1;">Generar PDF</button>
                            <button id="btnEnviarWhatsapp" style="flex:1;">Enviar WhatsApp</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="gestion-completa">
          <div class="grid-container">
            <div class="card">
              <div class="card-header"><h2>Gestión de Inventario</h2></div>
              <h3>Productos</h3>
              <form id="formProducto"><input type="hidden" id="idProducto" /><input type="text" id="nombreProducto" placeholder="Nombre producto" required /><input type="number" step="0.01" id="precioProducto" placeholder="Precio" required /><button type="submit">Guardar Producto</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
              <ul id="listaProductos"></ul>
            </div>
            <div class="card">
              <h3>Toppings</h3>
              <form id="formTopping"><input type="hidden" id="idTopping" /><input type="text" id="nombreTopping" placeholder="Nombre topping" required /><input type="number" step="0.01" id="precioTopping" placeholder="Precio" required /><button type="submit">Guardar Topping</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
              <ul id="listaToppings"></ul>
            </div>
            <div class="card">
              <h3>Jarabes</h3>
              <form id="formJarabe"><input type="hidden" id="idJarabe" /><input type="text" id="nombreJarabe" placeholder="Nombre jarabe" required /><input type="number" step="0.01" id="precioJarabe" placeholder="Precio" required /><button type="submit">Guardar Jarabe</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
              <ul id="listaJarabes"></ul>
            </div>
          </div>
        </section>
        <section id="gestion-clientes">
          <div class="card">
            <div class="card-header"><h2>Gestión de Clientes</h2></div>
            <form id="formCliente"><input type="hidden" id="idCliente" /><input type="text" id="nombreCliente" placeholder="Nombre del cliente" required /><input type="text" id="telCliente" placeholder="Teléfono (opcional)" /><input type="text" id="dirCliente" placeholder="Dirección (opcional)" /><button type="submit">Guardar Cliente</button><button type="button" class="btn-secondary" onclick="this.form.reset()">Limpiar</button></form>
            <ul id="listaClientes"></ul>
          </div>
        </section>
        <section id="gestion-usuarios">
          <div class="card">
            <div class="card-header"><h2>Gestión de Usuarios</h2></div>
            <form id="formUsuario">
              <input type="hidden" id="idUsuario" />
              <input type="text" id="usernameUsuario" placeholder="Nombre de usuario" required />
              <input type="password" id="passwordUsuario" placeholder="Contraseña (dejar en blanco para no cambiar)" />
              <select id="roleUsuario" required>
                  <option value="">-- Seleccionar Rol --</option>
                  <option value="seller">Vendedor</option>
                  <option value="admin">Administrador</option>
              </select>
              <div id="permisos-container">
                  <h3>Permisos</h3>
                  <label><input type="checkbox" name="permisos" value="pedidos"> Acceso a Pedidos Online</label>
                  <label><input type="checkbox" name="permisos" value="gestion"> Acceso a Gestión de Inventario</label>
                  <label><input type="checkbox" name="permisos" value="clientes"> Acceso a Clientes</label>
                  <label><input type="checkbox" name="permisos" value="historial"> Acceso a Historial</label>
                  <label><input type="checkbox" name="permisos" value="papelera"> Acceso a Papelera</label>
                  <label><input type="checkbox" name="permisos" value="usuarios"> Acceso a Gestión de Usuarios</label>
              </div>
              <button type="submit">Guardar Usuario</button>
              <button type="button" id="btnLimpiarFormUsuario" class="btn-secondary">Limpiar</button>
            </form>
            <h3>Usuarios Existentes</h3>
            <ul id="listaUsuarios"></ul>
          </div>
        </section>
        <section id="historial-ventas">
          <div class="card">
            <div class="card-header"><h2>Historial de Ventas</h2></div>
            <div id="filtros-historial">
                <div>
                    <label>Período</label>
                    <div id="botones-periodo">
                        <button data-periodo="dia" class="active">Hoy</button>
                        <button data-periodo="semana">Semana</button>
                        <button data-periodo="mes">Mes</button>
                    </div>
                </div>
                <div>
                    <label for="filtroEstatus">Filtrar por Estatus</label>
                    <select id="filtroEstatus">
                        <option value="">Todos</option>
                        <option value="Pagado">Pagado</option>
                        <option value="Pendiente de Pago">Pendiente de Pago</option>
                    </select>
                </div>
                <div>
                    <label for="filtroCliente">Filtrar por Cliente</label>
                    <select id="filtroCliente"></select>
                </div>
                <div id="filtro-usuario-container">
                    <label for="filtroUsuario">Filtrar por Vendedor</label>
                    <select id="filtroUsuario"></select>
                </div>
            </div>
          </div>
          <div class="grid-container">
            <div class="card">
                <h3>Ventas por Día</h3>
                <div class="chart-container"><canvas id="graficaVentas"></canvas></div>
            </div>
            <div class="card">
                <h3>Productos Más Vendidos</h3>
                <div class="chart-container"><canvas id="graficaProductos"></canvas></div>
            </div>
            <div class="card" id="resumen-container">
                <div class="card-header">
                    <h3>Resumen de Ventas</h3>
                </div>
                <div id="totalPeriodoHistorial"></div>
                <pre id="resumen-ventas"></pre>
                <div style="display:flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                    <button id="btnResumenWhatsapp" class="btn-secondary" style="flex-grow: 1;">Enviar Resumen por WhatsApp</button>
                    <button id="btnResumenPDF" class="btn-secondary" style="flex-grow: 1;">Generar PDF del Resumen</button>
                    <button id="btnGenerarReporte" style="flex-grow: 1;">Generar Reporte Completo</button>
                </div>
            </div>
            <div class="card full-width-card">
                <div class="card-header">
                    <h3>Detalle de Ventas</h3>
                    <div class="export-buttons" style="display:flex; gap: 0.5rem;">
                        <button id="btnDetalleWhatsapp" class="btn-secondary" title="Enviar Detalle por WhatsApp">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
                            </svg>
                        </button>
                        <button id="btnDetallePDF" class="btn-secondary" title="Generar PDF del Detalle">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                                <path d="M4.603 14.087a.8.8 0 0 1-1.128.001l-2.023-1.91a.5.5 0 0 1 .757-.793l2.023 1.91a.3.3 0 0 0 .424 0l4.869-4.633a.5.5 0 0 1 .645.768l-4.869 4.633a.8.8 0 0 1-.569.241z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr>
                          <th>ID Venta</th>
                          <th>Vendedor</th>
                          <th>Cliente</th>
                          <th>Total</th>
                          <th>Método de Pago</th>
                          <th>Estatus</th>
                          <th>Fecha</th>
                          <th>Acciones</th>
                        </tr></thead>
                        <tbody id="tablaVentasBody"></tbody>
                    </table>
                </div>
            </div>
          </div>
        </section>
        <section id="papelera-reciclaje">
            <div class="card">
                <div class="card-header"><h2>Papelera de Reciclaje</h2></div>
                <p>Aquí se muestran los elementos eliminados. Puedes restaurarlos o eliminarlos permanentemente.</p>
            </div>
            <div class="grid-container">
                <div class="card"><h3>Productos Eliminados</h3><ul id="papelera-productos"></ul></div>
                <div class="card"><h3>Toppings Eliminados</h3><ul id="papelera-toppings"></ul></div>
                <div class="card"><h3>Jarabes Eliminados</h3><ul id="papelera-jarabes"></ul></div>
                <div class="card"><h3>Clientes Eliminados</h3><ul id="papelera-clientes"></ul></div>
                <div class="card"><h3>Usuarios Eliminados</h3><ul id="papelera-usuarios"></ul></div>
                <div class="card full-width-card">
                    <h3>Ventas Eliminadas</h3>
                    <div style="overflow-x:auto;">
                        <table id="papelera-ventas-tabla">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="papelera-ventas"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      let ventaActual = [];
      let miGraficaDeVentas, miGraficaDeProductos;
      let ventasEnMemoria = [];
      let ventasFiltradasGlobal = [];
      let procesandoVenta = false;
      const COSTO_DOMICILIO_PREDET = 30.00;
      
      const loginContainer = document.getElementById('login-container');
      const appWrapper = document.getElementById('app-wrapper');
      const loginForm = document.getElementById('login-form');
      const logoutButton = document.getElementById('logout-button');
      const welcomeUserSpan = document.getElementById('welcome-user');
      const loginError = document.getElementById('login-error');
      const nav = document.querySelector('nav');
      const menuToggle = document.getElementById('menu-toggle');
      const mainContent = document.querySelector('.main-content');
      const { jsPDF } = window.jspdf;
      
      const themeSwitch = document.getElementById('theme-switch');
      const togglePassword = document.getElementById('toggle-password');
      const passwordInput = document.getElementById('password');
      const eyeOpen = document.getElementById('eye-open');
      const eyeClosed = document.getElementById('eye-closed');

      function applyTheme(theme) {
          if (theme === 'dark') {
              document.body.classList.add('dark-mode');
              themeSwitch.checked = true;
          } else {
              document.body.classList.remove('dark-mode');
              themeSwitch.checked = false;
          }
      }
      
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme) {
          applyTheme(savedTheme);
      } else if (systemPrefersDark) {
          applyTheme('dark');
      } else {
          applyTheme('light');
      }

      menuToggle.addEventListener('click', () => nav.classList.toggle('nav-open'));

      async function guardarConfiguracionServidor(config) {
          try {
              await fetchAPI('/api/configuracion', { 
                  method: 'POST', 
                  body: JSON.stringify(config) 
              }, true);
          } catch (error) {
              console.error("Error guardando configuración:", error);
              alert("No se pudo guardar la configuración. Revisa la conexión con el servidor.");
          }
      }

      function setupCustomizationEventListeners() {
          const logoInput = document.getElementById('logo-input');
          const appLogo = document.getElementById('app-logo');
          const primaryColorPicker = document.getElementById('primary-color-picker');
          const accentColorPicker = document.getElementById('accent-color-picker');
          const root = document.documentElement;

          appLogo.addEventListener('click', () => logoInput.click());

          logoInput.addEventListener('change', (event) => {
              const file = event.target.files[0];
              if (file) {
                  const reader = new FileReader();
                  reader.onload = (e) => {
                      const logo_base64 = e.target.result;
                      document.getElementById('app-logo').src = logo_base64;
                      document.getElementById('login-logo').src = logo_base64;
                      guardarConfiguracionServidor({ logo_base64 });
                  };
                  reader.readAsDataURL(file);
              }
          });

          primaryColorPicker.addEventListener('input', (event) => {
              const primary_color = event.target.value;
              root.style.setProperty('--primary-color', primary_color);
              guardarConfiguracionServidor({ primary_color });
          });
          
          accentColorPicker.addEventListener('input', (event) => {
              const accent_color = event.target.value;
              root.style.setProperty('--accent-color', accent_color);
              guardarConfiguracionServidor({ accent_color });
          });
      }

      async function loadPublicConfig() {
          const appLogo = document.getElementById('app-logo');
          const loginLogo = document.getElementById('login-logo');
          const primaryColorPicker = document.getElementById('primary-color-picker');
          const accentColorPicker = document.getElementById('accent-color-picker');
          const root = document.documentElement;
          
          try {
              const response = await fetch('/api/configuracion');
              if (!response.ok) {
                  throw new Error(`Error de red: ${response.statusText}`);
              }
              const config = await response.json();
              
              const defaultLogo = 'https://via.placeholder.com/180x60.png?text=Tu+Logo';
              
              if (config && config.logo_base64) {
                  appLogo.src = config.logo_base64;
                  loginLogo.src = config.logo_base64;
              } else {
                   appLogo.src = defaultLogo;
                   loginLogo.src = defaultLogo;
              }

              if (config && config.primary_color) {
                  root.style.setProperty('--primary-color', config.primary_color);
                  primaryColorPicker.value = config.primary_color;
              }

              if (config && config.accent_color) {
                  root.style.setProperty('--accent-color', config.accent_color);
                  accentColorPicker.value = config.accent_color;
              }
          } catch (error) {
              console.error("No se pudo cargar la configuración de apariencia desde el servidor.", error);
              const errorLogo = 'https://via.placeholder.com/180x60.png?text=Error';
              appLogo.src = errorLogo;
              loginLogo.src = errorLogo;
          }
      }

      async function showApp() {
        try {
            const token = localStorage.getItem('token');
            if (!token) { showLogin(); return; }
            const payload = JSON.parse(atob(token.split('.')[1]));
            welcomeUserSpan.textContent = `Bienvenido, ${payload.username} (${payload.role})`;
            
            const esAdmin = payload.role === 'admin';
            const permisos = payload.permissions || {};

            const mapaPermisos = {
                'pedidos': document.getElementById('btn-pedidos'),
                'gestion': document.querySelector('[data-seccion="gestion-completa"]'),
                'clientes': document.querySelector('[data-seccion="gestion-clientes"]'),
                'usuarios': document.querySelector('[data-seccion="gestion-usuarios"]'),
                'historial': document.querySelector('[data-seccion="historial-ventas"]'),
                'papelera': document.querySelector('[data-seccion="papelera-reciclaje"]')
            };

            for (const permiso in mapaPermisos) {
                const tieneAcceso = esAdmin || (permisos && permisos[permiso]);
                if (mapaPermisos[permiso]) {
                    mapaPermisos[permiso].style.display = tieneAcceso ? 'flex' : 'none';
                }
            }
            
            document.getElementById('customization-container').style.display = esAdmin ? 'block' : 'none';
            document.getElementById('filtro-usuario-container').style.display = esAdmin ? 'block' : 'none';
            
            initApp();
            
            let seccionInicial = sessionStorage.getItem('lastActiveSection');
            let seccionEsValida = false;

            const mapaSeccionesAPermisos = {
                'gestion-pedidos': 'pedidos',
                'gestion-completa': 'gestion',
                'gestion-clientes': 'clientes',
                'gestion-usuarios': 'usuarios',
                'historial-ventas': 'historial',
                'papelera-reciclaje': 'papelera'
            };

            if (seccionInicial) {
                if (seccionInicial === 'registrar-venta' || esAdmin) {
                    seccionEsValida = true;
                } else {
                    const permisoNecesario = mapaSeccionesAPermisos[seccionInicial];
                    if (permisos && permisos[permisoNecesario]) {
                        seccionEsValida = true;
                    }
                }
            }

            if (seccionEsValida) {
                mostrarSeccion(seccionInicial);
            } else {
                const ordenDeSecciones = ['gestion-pedidos', 'registrar-venta', 'gestion-completa', 'gestion-clientes', 'historial-ventas', 'gestion-usuarios', 'papelera-reciclaje'];
                let primeraEncontrada = '';
                for (const seccion of ordenDeSecciones) {
                    const permisoNecesario = mapaSeccionesAPermisos[seccion];
                    if (esAdmin || (permisos && permisos[permisoNecesario]) || seccion === 'registrar-venta') { 
                        primeraEncontrada = seccion; 
                        break; 
                    }
                }
                
                if (primeraEncontrada) {
                    mostrarSeccion(primeraEncontrada);
                } else {
                    alert('No tienes permisos asignados. Contacta a un administrador.');
                    document.querySelector('main').innerHTML = '<div class="card"><p>No tienes acceso a ninguna sección.</p></div>';
                }
            }

        } catch (e) { 
            console.error("Error en showApp:", e); 
            localStorage.removeItem('token');
            showLogin();
        }
      }
      
      function showLogin() {
        localStorage.removeItem('token');
        sessionStorage.removeItem('lastActiveSection');
        const style = document.head.querySelector('style[data-flicker-guard]');
        if (style) {
            style.textContent = '#login-container { display: block !important; } #app-wrapper { display: none !important; }';
        } else {
          loginContainer.style.display = 'block';
          appWrapper.style.display = 'none';
        }
      }
      
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const username = document.getElementById('username').value;
        const password = passwordInput.value;
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Credenciales inválidas');
            localStorage.setItem('token', data.token);
            sessionStorage.removeItem('lastActiveSection');
            const style = document.head.querySelector('style[data-flicker-guard]');
            if (style) {
                style.textContent = '#login-container { display: none !important; } #app-wrapper { display: flex !important; }';
            }
            await showApp();
        } catch (error) {
            loginError.textContent = error.message;
        }
      });

      logoutButton.addEventListener('click', () => { showLogin(); });
      
      async function fetchAPI(url, options = {}, suppressError = false) {
        const token = localStorage.getItem('token');
        if (!token) { showLogin(); throw new Error('No autenticado'); }
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (response.status === 204) return;
        if (response.status === 401) { showLogin(); throw new Error('Sesión expirada.'); }
        if (!response.ok) { 
            const errorData = await response.json(); 
            if (response.status === 403) {
              console.error(`Acceso denegado a ${url}:`, errorData.error);
            }
            if (suppressError) {
                console.error(`Error en la petición a ${url}:`, errorData.error);
                return;
            }
            throw new Error(errorData.error || `Error en la petición a ${url}`); 
        }
        return response.json();
      }
      
      function initApp() {
        setupEventListeners();
        setupCustomizationEventListeners();
        setupCollapsibles(); 
      }
      
      function mostrarSeccion(id) {
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(link => link.classList.remove('active-link'));
        const seccionActiva = document.getElementById(id);
        const linkActivo = document.querySelector(`nav a[data-seccion="${id}"]`);

        if (seccionActiva) {
          seccionActiva.classList.add('active');
          if (linkActivo) linkActivo.classList.add('active-link');
          
          sessionStorage.setItem('lastActiveSection', id);

          const cargarMap = {
            'gestion-pedidos': () => cargarPedidos(),
            'registrar-venta': () => cargarOpcionesParaVenta(),
            'gestion-completa': () => { cargarProductos(); cargarToppings(); cargarJarabes(); },
            'gestion-clientes': () => cargarClientes(),
            'gestion-usuarios': () => cargarUsuarios(),
            'historial-ventas': () => { cargarClientesParaFiltro(); cargarUsuariosParaFiltro(); cargarVentasHistorial(); },
            'papelera-reciclaje': () => cargarPapelera(),
          };
          cargarMap[id]?.();
        }
        nav.classList.remove('nav-open');
      }

      function setupCollapsibles() {
        document.querySelectorAll(".collapsible").forEach(c => {
          const newC = c.cloneNode(true);
          c.parentNode.replaceChild(newC, c);
          
          newC.addEventListener("click", function() {
            this.classList.toggle("active");
            const content = this.nextElementSibling;
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
              content.style.maxHeight = '0px';
            } else {
              content.style.maxHeight = content.scrollHeight + "px";
            }
          });
        });
      }
      
      const renderizarLista = (items = [], tipo, campos) => {
        const lista = document.getElementById(`lista${tipo}s`);
        if(!lista) return;
        lista.innerHTML = '';
        items.forEach(item => {
          const li = document.createElement('li');
          li.className = 'product-item';
          const texto = document.createElement('span');
          let displayText = item[campos[0]] || '';
          if (campos[1] && typeof item[campos[1]] === 'number') {
            displayText += ` - $${item[campos[1]].toFixed(2)}`;
          } else if (campos[1] && item[campos[1]]) {
            displayText += ` - ${item[campos[1]]}`;
          }
          texto.textContent = displayText;

          const divControles = document.createElement('div');
          divControles.style.display = 'flex';
          divControles.style.alignItems = 'center';
          divControles.style.gap = '1rem';

          if (tipo === 'Producto') {
            const switchContainer = document.createElement('div');
            switchContainer.className = 'agotado-switch';
            switchContainer.innerHTML = `
              <span>Agotado</span>
              <label class="theme-switch">
                <input type="checkbox" onchange="window.app.toggleAgotado('${item.id}')" ${item.agotado ? 'checked' : ''}>
                <span class="slider"></span>
              </label>
            `;
            divControles.appendChild(switchContainer);
          }
          
          const divBotones = document.createElement('div');
          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.onclick = () => {
              if(tipo === 'Usuario') {
                  cargarUsuarioEnForm(item);
              } else {
                  document.getElementById(`id${tipo}`).value = item.id;
                  document.getElementById(`nombre${tipo}`).value = item.nombre;
                  if (tipo === 'Cliente') {
                    document.getElementById(`tel${tipo}`).value = item.telefono || '';
                    document.getElementById(`dir${tipo}`).value = item.direccion || '';
                  } else { document.getElementById(`precio${tipo}`).value = item.precio; }
              }
          };
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'Eliminar';
          btnEliminar.className = 'btn-eliminar-item';
          btnEliminar.onclick = () => eliminarItem(item.id, tipo);
          divBotones.appendChild(btnEditar);
          divBotones.appendChild(btnEliminar);

          divControles.appendChild(divBotones);
          
          li.appendChild(texto);
          li.appendChild(divControles);
          lista.appendChild(li);
        });
      };
      
      async function guardarItem(e, tipo) {
        e.preventDefault();
        const form = e.target;
        const id = document.getElementById(`id${tipo}`).value;
        let body;
        if (tipo === 'Cliente') {
            body = { nombre: document.getElementById(`nombre${tipo}`).value, telefono: document.getElementById(`tel${tipo}`).value, direccion: document.getElementById(`dir${tipo}`).value };
            if (!body.nombre) { alert('El nombre del cliente es obligatorio.'); return; }
        } else {
            body = { nombre: document.getElementById(`nombre${tipo}`).value, precio: parseFloat(document.getElementById(`precio${tipo}`).value) };
            if (!body.nombre || isNaN(body.precio)) { alert('Completa los datos'); return; }
        }
        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/${tipo.toLowerCase()}s/${id}` : `/api/${tipo.toLowerCase()}s`;
        try {
          await fetchAPI(url, { method: metodo, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
          form.reset();
          document.getElementById(`id${tipo}`).value = '';
          await actualizarUIGlobal(tipo);
        } catch (err) { alert(`Error: ${err.message}`); }
      }

      async function eliminarItem(id, tipo) {
        if (confirm(`¿Mover este ${tipo.toLowerCase()} a la papelera?`)) {
          try {
            await fetchAPI(`/api/${tipo.toLowerCase()}s/${id}`, { method: 'DELETE' });
            await actualizarUIGlobal(tipo);
          } catch (err) { alert(`Error: ${err.message}`); }
        }
      }
      
      async function actualizarUIGlobal(tipo) {
        const cargaFuncs = {
          'Producto': [cargarProductos, cargarOpcionesParaVenta], 'Topping': [cargarToppings, cargarOpcionesParaVenta], 'Jarabe': [cargarJarabes, cargarOpcionesParaVenta],
          'Cliente': [cargarClientes, cargarOpcionesParaVenta, cargarClientesParaFiltro], 'Usuario': [cargarUsuarios, cargarUsuariosParaFiltro], 'Venta': [cargarVentasHistorial]
        };
        const funciones = cargaFuncs[tipo] || [];
        for (const func of funciones) { await func(); }
      }

      async function cargarProductos() { try { const data = await fetchAPI('/api/productos'); renderizarLista(data, 'Producto', ['nombre', 'precio']); } catch (e) { console.error(e); renderizarLista([], 'Producto', ['nombre', 'precio']); } }
      async function cargarToppings() { try { const data = await fetchAPI('/api/toppings'); renderizarLista(data, 'Topping', ['nombre', 'precio']); } catch (e) { console.error(e); renderizarLista([], 'Topping', ['nombre', 'precio']); } }
      async function cargarJarabes() { try { const data = await fetchAPI('/api/jarabes'); renderizarLista(data, 'Jarabe', ['nombre', 'precio']); } catch (e) { console.error(e); renderizarLista([], 'Jarabe', ['nombre', 'precio']); } }
      async function cargarClientes() { try { const data = await fetchAPI('/api/clientes'); renderizarLista(data, 'Cliente', ['nombre', 'telefono']); } catch (e) { console.error(e); renderizarLista([], 'Cliente', ['nombre', 'telefono']); } }
      
      async function cargarOpcionesParaVenta() { 
        try {
            await Promise.all([ 
                cargarDataParaSelector('/api/productos', 'ventaProducto', 'id', item => `${item.nombre} - $${item.precio.toFixed(2)}`), 
                cargarDataParaSelector('/api/clientes', 'ventaCliente', 'id', 'nombre'),
                cargarDataParaBotones('/api/toppings', 'toppings-container'),
                cargarDataParaBotones('/api/jarabes', 'jarabes-container') 
            ]);
            setupCollapsibles();
        } catch(e) {
            console.error("Fallo al cargar opciones para la venta:", e);
        }
      }
      
      async function cargarDataParaSelector(url, selectId, valueField, textField) {
        try {
          const data = await fetchAPI(url);
          if (!data) return;
          const select = document.getElementById(selectId);
          const currentValue = select.value;
          let optionsHtml = selectId === 'ventaCliente' ? '<option value="">Público General</option>' : '<option value="">-- Selecciona un producto --</option>';
          data.forEach(item => {
            let text = typeof textField === 'function' ? textField(item) : item[textField];
            optionsHtml += `<option value="${item[valueField]}" data-precio="${item.precio || 0}">${text}</option>`;
          });
          select.innerHTML = optionsHtml;
          select.value = currentValue;
        } catch(e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarDataParaBotones(url, containerId) {
          try{
              const data = await fetchAPI(url);
              if (!data) return;
              const container = document.getElementById(containerId);
              container.innerHTML = '';
              data.forEach(item => {
                  const button = document.createElement('button');
                  button.className = 'option-btn';
                  button.textContent = `${item.nombre} - $${item.precio.toFixed(2)}`;
                  button.dataset.id = item.id;
                  button.dataset.precio = item.precio;
                  button.dataset.nombre = item.nombre;
                  button.onclick = () => {
                      button.classList.toggle('selected');
                  };
                  container.appendChild(button);
              });
          } catch(e) { /* Error manejado en fetchAPI */ }
      }
      
      function resetearFormularioItem() {
          document.getElementById('ventaProducto').value = '';
          document.getElementById('ventaCantidad').value = '1';
          document.getElementById('ventaNota').value = '';
          document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
          document.querySelectorAll(".collapsible.active").forEach(c => {
              c.classList.remove('active');
              c.nextElementSibling.style.maxHeight = '0px';
          });
      }

      function agregarAVenta() {
        const productoSelect = document.getElementById('ventaProducto');
        if (!productoSelect.value) { alert('Selecciona un producto'); return; }
        const productoNombre = productoSelect.options[productoSelect.selectedIndex].text.split(' - ')[0];
        const cantidad = parseInt(document.getElementById('ventaCantidad').value) || 1;
        const toppings = Array.from(document.querySelectorAll('#toppings-container .option-btn.selected')).map(btn => ({ nombre: btn.dataset.nombre }));
        const jarabes = Array.from(document.querySelectorAll('#jarabes-container .option-btn.selected')).map(btn => ({ nombre: btn.dataset.nombre }));
        const nota = document.getElementById('ventaNota').value.trim();
        let totalItem = (parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.precio) * cantidad) + 
                        Array.from(document.querySelectorAll('.option-btn.selected')).reduce((acc, btn) => acc + parseFloat(btn.dataset.precio), 0);
        
        ventaActual.push({ productoNombre, cantidad, toppings, jarabes, nota, total: totalItem });
        
        if (ventaActual.length > 0) {
            document.getElementById('ventaCliente').disabled = true;
        }

        mostrarVentaActual();
        resetearFormularioItem();
      }

      async function registrarVenta(estatus) {
        if (procesandoVenta) return; 
        procesandoVenta = true;
        const btnPagado = document.getElementById('btnRegistrarPagado');
        const btnPendiente = document.getElementById('btnRegistrarPendiente');
        const btnActualizar = document.getElementById('btnActualizarVenta');
        [btnPagado, btnPendiente, btnActualizar].forEach(btn => btn.disabled = true);
        
        try {
            if (ventaActual.length === 0) {
                alert('Agrega al menos un producto a la venta');
                return;
            }
            const clienteSelect = document.getElementById('ventaCliente');
            const costoDomicilio = document.getElementById('checkDomicilio').checked ? parseFloat(document.getElementById('costoDomicilio').value || 0) : 0;
            const subtotal = ventaActual.reduce((a, i) => a + i.total, 0);
            
            const idVentaEditada = document.getElementById('idVenta').value;
            const ventaOriginal = idVentaEditada ? ventasEnMemoria.find(v => v.id === idVentaEditada) : {};

            const ventaData = { 
                fecha: new Date().toISOString(), 
                clienteId: clienteSelect.value || null,
                clienteNombre: clienteSelect.value ? clienteSelect.options[clienteSelect.selectedIndex].text : 'Público General',
                items: ventaActual, 
                subtotal: subtotal, 
                costoDomicilio: costoDomicilio, 
                total: subtotal + costoDomicilio,
                metodoPago: document.getElementById('metodoPago').value,
                estatus: estatus || ventaOriginal.estatus
            };
            
            const url = idVentaEditada ? `/api/ventas/${idVentaEditada}` : '/api/ventas';
            const metodo = idVentaEditada ? 'PUT' : 'POST';

            const ventaGuardada = await fetchAPI(url, { method: metodo, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ventaData) });
            alert(`Venta ${idVentaEditada ? 'actualizada' : 'guardada como ' + estatus} con éxito`);
            document.getElementById('ticket').textContent = generarTextoTicket(ventaGuardada);
            resetearFormularioCompleto();
            await cargarVentasHistorial();
        } catch (e) {
            alert(`Error: ${e.message}`);
        } finally {
            procesandoVenta = false;
            [btnPagado, btnPendiente, btnActualizar].forEach(btn => btn.disabled = false);
        }
      }

      function mostrarVentaActual() {
        const lista = document.getElementById('listaVentaActual');
        lista.innerHTML = '';
        ventaActual.forEach((item, index) => {
          const li = document.createElement('li');
          const itemInfo = document.createElement('div');
          itemInfo.innerHTML = `<span>${item.productoNombre} x${item.cantidad} - $${item.total.toFixed(2)}</span>`;
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'X';
          btnEliminar.className = 'btn-eliminar-item';
          btnEliminar.onclick = () => { 
            ventaActual.splice(index, 1); 
            if (ventaActual.length === 0 && !document.getElementById('idVenta').value) {
                document.getElementById('ventaCliente').disabled = false;
            }
            mostrarVentaActual(); 
          };
          itemInfo.appendChild(btnEliminar);
          li.appendChild(itemInfo);
          if (item.nota) {
            const notaDiv = document.createElement('div');
            notaDiv.textContent = `Nota: ${item.nota}`;
            li.appendChild(notaDiv);
          }
          lista.appendChild(li);
        });
        actualizarTotalVenta();
      }

      function actualizarTotalVenta() {
        const subtotalVenta = ventaActual.reduce((acc, item) => acc + item.total, 0);
        const costoDomicilio = document.getElementById('checkDomicilio').checked ? parseFloat(document.getElementById('costoDomicilio').value || 0) : 0;
        const totalFinal = subtotalVenta + costoDomicilio;
        document.getElementById('totalVenta').textContent = `Total Venta: $${totalFinal.toFixed(2)}`;
      }

      function resetearFormularioCompleto() {
        ventaActual = [];
        document.getElementById('formVenta').reset();
        document.getElementById('ventaCliente').disabled = false;
        document.getElementById('idVenta').value = '';
        document.getElementById('checkDomicilio').checked = false;
        document.getElementById('costoDomicilio').style.display = 'none';
        document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
        document.querySelectorAll(".collapsible.active").forEach(c => {
            c.classList.remove('active');
            c.nextElementSibling.style.maxHeight = '0px';
        });
        document.getElementById('metodoPago').value = "Efectivo";
        document.getElementById('botones-finalizar-venta').style.display = 'flex';
        document.getElementById('btnActualizarVenta').style.display = 'none';
        mostrarVentaActual();
      }

      function generarTextoTicket(venta) {
        let texto = `--- Ticket Dulces Amigas ---\nFecha: ${new Date(venta.fecha).toLocaleString()}\nCliente: ${venta.clienteNombre}\nAtendido por: ${venta.vendedorUsername}\n\n`;
        venta.items.forEach((n, a) => {
          texto += `${a + 1}. ${n.productoNombre} x${n.cantidad}\n`;
          if (n.toppings && n.toppings.length) texto += `   + Toppings: ${n.toppings.map(e => e.nombre).join(", ")}\n`;
          if (n.jarabes && n.jarabes.length) texto += `   + Jarabes: ${n.jarabes.map(e => e.nombre).join(", ")}\n`;
          if (n.nota) texto += `   * Nota: ${n.nota}\n`;
          texto += `   Subtotal Item: $${n.total.toFixed(2)}\n\n`;
        });
        texto += `---------------------------\nSubtotal: $${venta.subtotal.toFixed(2)}\n`;
        if (venta.costoDomicilio > 0) texto += `Domicilio: $${venta.costoDomicilio.toFixed(2)}\n`;
        texto += `TOTAL: $${venta.total.toFixed(2)}\n`;
        texto += `Método de pago: ${venta.metodoPago || 'N/A'}\n`;
        texto += `Estatus: ${venta.estatus || 'N/A'}\n---------------------------\n¡Gracias por tu compra!`;
        return texto;
      }
      
      async function cargarUsuarios() { /* ... */ }
      function limpiarFormularioUsuario() { /* ... */ }
      function cargarUsuarioEnForm(usuario) { /* ... */ }
      async function guardarUsuario(e) { /* ... */ }
      async function marcarComoPagado(ventaId) { /* ... */ }
      async function cambiarEstatus(ventaId, estatusActual) { /* ... */ }
      function reimprimirTicket(ventaId) { /* ... */ }
      function editarVenta(ventaId) { /* ... */ }
      async function cargarVentasHistorial() { /* ... */ }
      async function cargarUsuariosParaFiltro() { /* ... */ }
      async function cargarClientesParaFiltro() { /* ... */ }
      async function cargarPapelera() { /* ... */ }
      function renderizarPapelera(items, tipo) { /* ... */ }
      function renderizarPapeleraVentas(items) { /* ... */ }
      async function restaurarItem(id, tipo) { /* ... */ }
      async function eliminarPermanentemente(id, tipo) { /* ... */ }
      function prepararDatosParaGraficas(ventas) { /* ... */ }
      function actualizarGraficaBarras(labels, data) { /* ... */ }
      function actualizarGraficaCircular(labels, data) { /* ... */ }
      function generarResumen(ventas) { /* ... */ }
      function generarReportePDF() { /* ... */ }
      function enviarResumenWhatsapp() { /* ... */ }
      function generarResumenPDFSimple() { /* ... */ }
      function enviarDetalleWhatsapp() { /* ... */ }
      function generarDetallePDF() { /* ... */ }
      async function cargarPedidos() { /* ... */ }
      async function cambiarEstatusPedido(id, nuevoEstatus) { /* ... */ }
      async function cancelarPedido(id, nombre) { /* ... */ }
      async function convertirPedidoAVenta(pedido) { /* ... */ }
      async function toggleAgotado(id) { /* ... */ }
      function setupEventListeners() { /* ... */ }
      
      window.app = { toggleAgotado, cancelarPedido, cambiarEstatusPedido, convertirPedidoAVenta };

      await loadPublicConfig();

      if (localStorage.getItem('token')) {
        await showApp();
      } else {
        showLogin();
      }
      
      document.body.style.visibility = 'visible';
    });
  </script>
</body>
</html>