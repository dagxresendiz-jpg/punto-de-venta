<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dulces Amigas - Punto de Venta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4f46e5; --primary-hover: #4338ca; --danger-color: #ef4444; --danger-hover: #dc2626;
      --success-color: #22c55e; --info-color: #38bdf8; --background-color: #f8fafc; --card-background: #ffffff;
      --text-color-dark: #1e293b; --text-color-light: #64748b; --border-color: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color-dark); -webkit-font-smoothing: antialiased; }
    
    .app-wrapper { display: flex; min-height: 100vh; }
    
    .sidebar { width: 250px; background-color: var(--card-background); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem 1rem; transition: transform 0.3s ease; }
    .sidebar-header { text-align: center; margin-bottom: 2rem; font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; }
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 8px; text-decoration: none; color: var(--text-color-light); font-weight: 500; transition: all 0.2s ease; cursor: pointer; }
    .nav-link:hover { background-color: var(--background-color); color: var(--primary-color); }
    .nav-link.active-link { background-color: var(--primary-color); color: white; }
    .nav-link svg { width: 20px; height: 20px; stroke-width: 2; }

    .main-content { flex: 1; display: flex; flex-direction: column; }
    .main-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); }
    .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    #logout-button { background-color: var(--danger-color); color: white; border: none; font-weight: 500; }
    main { padding: 2rem; overflow-y: auto; }
    
    section { display: none; }
    section.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card { background-color: var(--card-background); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
    .card-header { margin-bottom: 1.5rem; }
    .card-header h2 { font-size: 1.25rem; font-weight: 600; border: none; padding: 0; }
    .card h3 { margin-top: 1.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-weight: 600; }
    .card h3:first-child { margin-top: 0; }
    form label { display: block; margin-bottom: 0.5rem; font-weight: 500; text-align: left; color: var(--text-color-dark); }
    form input, form select { display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; transition: box-shadow 0.2s, border-color 0.2s; }
    form input:focus, form select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px #c7d2fe; outline: none; }
    button { cursor: pointer; border-radius: 8px; border: none; padding: 0.75rem 1.25rem; font-weight: 600; transition: all 0.2s; }
    button[type="submit"], #btnAgregarVenta, #btnRegistrarVenta { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover, #btnAgregarVenta:hover, #btnRegistrarVenta:hover { background-color: var(--primary-hover); }
    .btn-eliminar-item, .btn-eliminar-venta { background-color: var(--danger-color); color: white; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
    
    #listaVentaActual { margin-bottom: 1rem; }
    #listaVentaActual li { flex-direction: column; align-items: stretch; }
    #opcion-domicilio { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; }
    #opcion-domicilio > div { display: flex; align-items: center; gap: 0.5rem; }
    #opcion-domicilio input[type="checkbox"] { width: auto; margin: 0; }
    #opcion-domicilio input[type="number"] { width: 100px; margin: 0; padding: 0.5rem; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: #f8fafc; font-weight: 600; color: var(--text-color-light); }
    
    #login-container { max-width: 400px; margin: 15vh auto; background: white; box-shadow: var(--shadow); border-radius: 12px; }
    #login-error { color: var(--danger-color); min-height: 1.2em; font-size: 0.9em; }

    .collapsible-wrapper { margin-bottom: 1rem; }
    .collapsible { width: 100%; text-align: left; font-weight: 500; background-color: #f1f5f9; border: 1px solid var(--border-color); border-radius: 8px; }
    .content-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
    .options-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; }
    .option-btn { padding: 0.5rem 1rem; font-weight: 500; background-color: #f8fafc; border: 1px solid var(--border-color); }
    .option-btn.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    
    #btnGenerarReporte { background-color: var(--info-color); color: white; }
    #btnGenerarPDF { background-color: #E53E3E; color: white; }
    #btnGenerarPDF:hover { background-color: #C53030; }
    #btnEnviarWhatsapp { background-color: #25D366; color: white; }
    #btnEnviarWhatsapp:hover { background-color: #128C7E; }
    
    #historial-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; }
    .chart-container { position: relative; height: 350px; }
    #totalPeriodoHistorial { font-weight: bold; font-size: 1.3em; text-align: center; margin-top: 1.5rem; padding: 1rem; background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; border-radius: 8px; }
    
    @media (max-width: 992px) {
      .menu-toggle { display: block; }
      .sidebar { position: fixed; left: 0; top: 0; bottom: 0; z-index: 1000; transform: translateX(-100%); }
      .sidebar.nav-open { transform: translateX(0); }
      .app-wrapper { display: block; }
      main { padding: 1rem; }
      .card { padding: 1rem; }
      #opcion-domicilio { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      #historial-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div id="login-container" class="card">
    <div class="card-header"><h2 style="text-align: center;">Iniciar Sesión</h2></div>
    <form id="login-form">
      <div><label for="username">Usuario</label><input type="text" id="username" required></div>
      <div><label for="password">Contraseña</label><input type="password" id="password" required></div>
      <button type="submit" style="width:100%;">Entrar</button>
      <p id="login-error"></p>
    </form>
  </div>

  <div id="app-wrapper" style="display:none;">
    <nav class="sidebar">
      <div class="sidebar-header">Dulces Amigas</div>
      <div class="sidebar-nav">
        <a class="nav-link" data-seccion="registrar-venta"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-6.967c.124-.467-.202-1.026-.693-1.026H6.118" /></svg><span>Registrar Venta</span></a>
        <a class="nav-link" data-seccion="gestion-completa" id="btn-gestion"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg><span>Gestión</span></a>
        <a class="nav-link" data-seccion="gestion-clientes" id="btn-clientes"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663c.278.472.548.972.786 1.503z" /></svg><span>Clientes</span></a>
        <a class="nav-link" data-seccion="gestion-usuarios" id="btn-usuarios"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962c.57-1.023.994-2.131 1.253-3.284C13.437 11.08 14 9.61 14 8c0-1.61-.563-3.08-1.5-4.216m-4.5 14.15a9.083 9.083 0 01-1.253-3.284C6.563 13.08 6 11.61 6 10c0-1.61.563-3.08 1.5-4.216m0 0a5.012 5.012 0 011.5 0c.828 1.136 1.5 2.606 1.5 4.216 0 1.61-.563-3.08-1.5 4.216m0 0l-2.25 2.25a5.012 5.012 0 01-1.5 0l-2.25-2.25m0 0a5.012 5.012 0 00-1.5 0l-2.25 2.25a5.012 5.012 0 00-1.5 0l-2.25-2.25m0 0a5.012 5.012 0 01-1.5 0l-2.25 2.25" /></svg><span>Usuarios</span></a>
        <a class="nav-link" data-seccion="historial-ventas"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 1.5m1-1.5l1-1.5m0 0l1 1.5m-2-1.5v-6.375c0-1.125.9-2.025 2-2.025h.5c1.1 0 2 .9 2 2.025v6.375m-4.5-3.375V8.25" /></svg><span>Historial</span></a>
      </div>
    </nav>

    <div class="main-content">
      <header class="main-header">
        <button class="menu-toggle" id="menu-toggle">&#9776;</button>
        <div class="user-info">
          <span id="welcome-user"></span>
          <button id="logout-button">Cerrar Sesión</button>
        </div>
      </header>
      <main>
        <section id="registrar-venta">
            <div class="grid-container">
                <div class="card">
                    <div class="card-header"><h2>Registrar Venta</h2></div>
                    <form id="formVenta" onsubmit="return false;">
                        <label for="ventaCliente">Cliente:</label> <select id="ventaCliente"></select>
                        <label for="ventaProducto">Producto:</label> <select id="ventaProducto" required></select>
                        <label for="ventaCantidad">Cantidad:</label> <input type="number" id="ventaCantidad" min="1" value="1" required />
                        <div class="collapsible-wrapper">
                            <button type="button" class="collapsible">Seleccionar Toppings</button>
                            <div class="content-collapsible"><div class="options-grid" id="toppings-container"></div></div>
                        </div>
                        <div class="collapsible-wrapper">
                            <button type="button" class="collapsible">Seleccionar Jarabes</button>
                            <div class="content-collapsible"><div class="options-grid" id="jarabes-container"></div></div>
                        </div>
                        <div id="opcion-domicilio">
                            <div><input type="checkbox" id="checkDomicilio"><label for="checkDomicilio">Servicio a domicilio</label></div>
                            <input type="number" id="costoDomicilio" step="0.01" placeholder="Costo" style="display: none;">
                        </div>
                        <label for="ventaNota">Nota para este producto (opcional):</label>
                        <input type="text" id="ventaNota" placeholder="Ej: Sin nuez, extra chocolate, etc." />
                        <button id="btnAgregarVenta" type="button">Agregar a Venta Actual</button>
                    </form>
                </div>
                <div>
                    <div class="card">
                        <div class="card-header"><h3>Venta Actual</h3></div>
                        <ul id="listaVentaActual"></ul>
                        <div id="totalVenta" style="font-weight:600; font-size: 1.2rem; margin-top: 1rem; text-align: right;">Total venta actual: $0.00</div>
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border-color);">
                        <label for="metodoPago">Método de Pago:</label>
                        <select id="metodoPago">
                            <option value="Efectivo">Efectivo</option> <option value="Tarjeta">Tarjeta</option> <option value="Transferencia">Transferencia</option>
                        </select>
                        <button id="btnRegistrarVenta">Registrar Venta Completa</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Ticket</h3></div>
                        <pre id="ticket"></pre>
                        <div style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <button id="btnGenerarPDF" style="flex:1;">Generar PDF</button>
                            <button id="btnEnviarWhatsapp" style="flex:1;">Enviar por WhatsApp</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="gestion-completa">
          <div class="grid-container">
            <div class="card">
              <div class="card-header"><h2>Gestión de Inventario</h2></div>
              <h3>Productos</h3>
              <form id="formProducto"><input type="hidden" id="idProducto" /><input type="text" id="nombreProducto" placeholder="Nombre producto" required /><input type="number" step="0.01" id="precioProducto" placeholder="Precio" required /><button type="submit">Guardar Producto</button><button type="button" onclick="this.form.reset()" style="background-color: #f1f5f9;">Limpiar</button></form>
              <ul id="listaProductos"></ul>
            </div>
            <div class="card">
              <h3>Toppings</h3>
              <form id="formTopping"><input type="hidden" id="idTopping" /><input type="text" id="nombreTopping" placeholder="Nombre topping" required /><input type="number" step="0.01" id="precioTopping" placeholder="Precio" required /><button type="submit">Guardar Topping</button><button type="button" onclick="this.form.reset()" style="background-color: #f1f5f9;">Limpiar</button></form>
              <ul id="listaToppings"></ul>
            </div>
            <div class="card">
              <h3>Jarabes</h3>
              <form id="formJarabe"><input type="hidden" id="idJarabe" /><input type="text" id="nombreJarabe" placeholder="Nombre jarabe" required /><input type="number" step="0.01" id="precioJarabe" placeholder="Precio" required /><button type="submit">Guardar Jarabe</button><button type="button" onclick="this.form.reset()" style="background-color: #f1f5f9;">Limpiar</button></form>
              <ul id="listaJarabes"></ul>
            </div>
          </div>
        </section>

        <section id="gestion-clientes">
          <div class="card">
            <div class="card-header"><h2>Gestión de Clientes</h2></div>
            <form id="formCliente"><input type="hidden" id="idCliente" /><input type="text" id="nombreCliente" placeholder="Nombre del cliente" required /><input type="text" id="telCliente" placeholder="Teléfono (opcional)" /><input type="text" id="dirCliente" placeholder="Dirección (opcional)" /><button type="submit">Guardar Cliente</button><button type="button" onclick="this.form.reset()" style="background-color: #f1f5f9;">Limpiar</button></form>
            <ul id="listaClientes"></ul>
          </div>
        </section>

        <section id="gestion-usuarios">
          <div class="card">
            <div class="card-header"><h2>Gestión de Usuarios</h2></div>
            <h3>Crear Nuevo Usuario</h3>
            <form id="formUsuario"><input type="text" id="usernameUsuario" placeholder="Nombre de usuario" required /><input type="password" id="passwordUsuario" placeholder="Contraseña" required /><select id="roleUsuario" required><option value="">-- Seleccionar Rol --</option><option value="seller">Vendedor</option><option value="admin">Administrador</option></select><button type="submit">Crear Usuario</button></form>
            <h3>Usuarios Existentes</h3>
            <ul id="listaUsuarios"></ul>
          </div>
        </section>

        <section id="historial-ventas">
          <div class="card">
            <div class="card-header"><h2>Historial de Ventas</h2></div>
            <div id="filtros-historial">
                <div>
                    <label>Período:</label>
                    <div id="botones-periodo"><button data-periodo="dia" class="active">Hoy</button><button data-periodo="semana">Semana</button><button data-periodo="mes">Mes</button></div>
                </div>
                <div><label for="filtroCliente">Filtrar por Cliente:</label><select id="filtroCliente"></select></div>
                <div id="filtro-usuario-container"><label for="filtroUsuario">Filtrar por Vendedor:</label><select id="filtroUsuario"></select></div>
            </div>
          </div>
          <div id="historial-layout">
            <div class="card">
                <h3>Ventas por Día</h3>
                <div class="chart-container"><canvas id="graficaVentas"></canvas></div>
            </div>
            <div class="card">
                <h3>Productos Más Vendidos</h3>
                <div class="chart-container"><canvas id="graficaProductos"></canvas></div>
            </div>
          </div>
          <div id="totalPeriodoHistorial"></div>
          <div class="card" id="resumen-container">
              <h3>Resumen de Ventas del Período</h3>
              <pre id="resumen-ventas"></pre>
              <button id="btnGenerarReporte">Generar Reporte PDF</button>
          </div>
          <div class="card">
              <h3>Detalle de Ventas</h3>
              <div style="overflow-x:auto;">
                  <table>
                      <thead><tr><th>ID Venta</th><th>Vendedor</th><th>Cliente</th><th>Total</th><th>Fecha</th><th></th></tr></thead>
                      <tbody id="tablaVentasBody"></tbody>
                  </table>
              </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- REFERENCIAS A ELEMENTOS DEL DOM ---
      const loginContainer = document.getElementById('login-container');
      const appWrapper = document.getElementById('app-wrapper');
      const loginForm = document.getElementById('login-form');
      const logoutButton = document.getElementById('logout-button');
      const welcomeUserSpan = document.getElementById('welcome-user');
      const loginError = document.getElementById('login-error');
      const btnGestion = document.getElementById('btn-gestion');
      const btnClientes = document.getElementById('btn-clientes');
      const btnUsuarios = document.getElementById('btn-usuarios');
      const nav = document.querySelector('nav');
      const menuToggle = document.getElementById('menu-toggle');
      
      const { jsPDF } = window.jspdf;
      let ventaActual = [];
      let miGraficaDeVentas, miGraficaDeProductos;
      const COSTO_DOMICILIO_PREDET = 30.00; 

      // --- LÓGICA DE AUTENTICACIÓN Y NAVEGACIÓN MÓVIL ---
      menuToggle.addEventListener('click', () => nav.classList.toggle('nav-open'));
      
      function showApp() {
        try {
          const token = localStorage.getItem('token');
          const payload = JSON.parse(atob(token.split('.')[1]));
          welcomeUserSpan.textContent = `Bienvenido, ${payload.username} (${payload.role})`;
          const esAdmin = payload.role === 'admin';
          btnGestion.style.display = esAdmin ? 'flex' : 'none';
          btnClientes.style.display = esAdmin ? 'flex' : 'none';
          btnUsuarios.style.display = esAdmin ? 'flex' : 'none';
          document.getElementById('filtro-usuario-container').style.display = esAdmin ? 'flex' : 'none';
          appWrapper.style.display = 'flex';
          loginContainer.style.display = 'none';
          initApp();
        } catch (e) { showLogin(); }
      }
      
      function showLogin() {
        localStorage.removeItem('token');
        appWrapper.style.display = 'none';
        loginContainer.style.display = 'block';
      }
      
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Credenciales inválidas');
            localStorage.setItem('token', data.token);
            showApp();
        } catch (error) {
            loginError.textContent = error.message;
        }
      });

      logoutButton.addEventListener('click', () => { showLogin(); });
      
      async function fetchAPI(url, options = {}) {
        const token = localStorage.getItem('token');
        if (!token) { showLogin(); throw new Error('No autenticado'); }
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
        options.cache = 'no-cache'; 
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401 || response.status === 403) { showLogin(); throw new Error('Sesión expirada.'); }
        if (response.status === 204) return;
        if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error || `Error en la petición a ${url}`); }
        return response.json();
      }
      
      function initApp() {
        setupEventListeners();
        const token = localStorage.getItem('token');
        const payload = JSON.parse(atob(token.split('.')[1]));
        const seccionInicial = payload.role === 'admin' ? 'historial-ventas' : 'registrar-venta';
        mostrarSeccion(seccionInicial);
      }

      function mostrarSeccion(id) {
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(link => link.classList.remove('active-link'));
        const seccionActiva = document.getElementById(id);
        const linkActivo = document.querySelector(`nav a[data-seccion="${id}"]`);

        if (seccionActiva) {
          seccionActiva.classList.add('active');
          if (linkActivo) linkActivo.classList.add('active-link');
          const cargarMap = {
            'registrar-venta': () => cargarOpcionesParaVenta(),
            'gestion-completa': () => { cargarProductos(); cargarToppings(); cargarJarabes(); },
            'gestion-clientes': () => cargarClientes(),
            'gestion-usuarios': () => cargarUsuarios(),
            'historial-ventas': () => { cargarClientesParaFiltro(); cargarUsuariosParaFiltro(); cargarVentasHistorial(); }
          };
          cargarMap[id]?.();
        }
        nav.classList.remove('nav-open');
      }
      
      // --- CORRECCIÓN DE COLLAPSIBLES ---
      function setupCollapsibles() {
        document.querySelectorAll(".collapsible").forEach(c => {
          // Remover event listeners antiguos para evitar duplicados, una forma más segura
          const newC = c.cloneNode(true);
          c.parentNode.replaceChild(newC, c);
          
          newC.addEventListener("click", function() {
            this.classList.toggle("active");
            const content = this.nextElementSibling;
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
              content.style.maxHeight = '0px';
            } else {
              content.style.maxHeight = content.scrollHeight + "px";
            }
          });
        });
      }
      
      const renderizarLista = (items = [], tipo, campos) => {
        const lista = document.getElementById(`lista${tipo}s`);
        if(!lista) return;
        lista.innerHTML = '';
        items.forEach(item => {
          const li = document.createElement('li');
          const texto = document.createElement('span');
          let displayText = item[campos[0]] || '';
          if (campos[1] && item[campos[1]]) {
            let secondField = (typeof item[campos[1]] === 'number') ? `$${item[campos[1]].toFixed(2)}` : item[campos[1]];
            displayText += ` - ${secondField}`;
          }
          texto.textContent = displayText;
          const divBotones = document.createElement('div');
          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.onclick = () => {
            document.getElementById(`id${tipo}`).value = item.id;
            document.getElementById(`nombre${tipo}`).value = item.nombre;
            if (tipo === 'Cliente') {
              document.getElementById(`tel${tipo}`).value = item.telefono || '';
              document.getElementById(`dir${tipo}`).value = item.direccion || '';
            } else { document.getElementById(`precio${tipo}`).value = item.precio; }
          };
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'Eliminar';
          btnEliminar.className = 'btn-eliminar-item';
          btnEliminar.onclick = () => eliminarItem(item.id, tipo);
          divBotones.appendChild(btnEditar);
          divBotones.appendChild(btnEliminar);
          li.appendChild(texto);
          li.appendChild(divBotones);
          lista.appendChild(li);
        });
      };
      
      async function guardarItem(e, tipo) {
        e.preventDefault();
        const form = e.target;
        const id = document.getElementById(`id${tipo}`).value;
        let body;
        if (tipo === 'Cliente') {
            body = { nombre: document.getElementById(`nombre${tipo}`).value, telefono: document.getElementById(`tel${tipo}`).value, direccion: document.getElementById(`dir${tipo}`).value };
            if (!body.nombre) { alert('El nombre del cliente es obligatorio.'); return; }
        } else {
            body = { nombre: document.getElementById(`nombre${tipo}`).value, precio: parseFloat(document.getElementById(`precio${tipo}`).value) };
            if (!body.nombre || isNaN(body.precio)) { alert('Completa los datos'); return; }
        }
        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `/api/${tipo.toLowerCase()}s/${id}` : `/api/${tipo.toLowerCase()}s`;
        try {
          await fetchAPI(url, { method: metodo, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
          form.reset();
          await actualizarUIGlobal(tipo);
        } catch (err) { alert(`Error: ${err.message}`); }
      }

      async function eliminarItem(id, tipo) {
        if (confirm(`¿Eliminar este ${tipo.toLowerCase()}?`)) {
          try {
            await fetchAPI(`/api/${tipo.toLowerCase()}s/${id}`, { method: 'DELETE' });
            await actualizarUIGlobal(tipo);
          } catch (err) { alert(`Error: ${err.message}`); }
        }
      }
      
      async function actualizarUIGlobal(tipo) {
        const updateMap = {
          'Producto': [cargarProductos, cargarProductosParaVenta], 'Topping': [cargarToppings, cargarToppingsParaVenta],
          'Jarabe': [cargarJarabes, cargarJarabesParaVenta], 'Cliente': [cargarClientes, cargarClientesParaVenta, cargarClientesParaFiltro],
          'Usuario': [cargarUsuarios, cargarUsuariosParaFiltro]
        };
        const funcionesAActualizar = updateMap[tipo] || [];
        for (const func of funcionesAActualizar) { await func(); }
      }

      async function cargarProductos() { try { const data = await fetchAPI('/api/productos'); renderizarLista(data, 'Producto', ['nombre', 'precio']); } catch (e) { renderizarLista([], 'Producto', ['nombre', 'precio']); } }
      async function cargarToppings() { try { const data = await fetchAPI('/api/toppings'); renderizarLista(data, 'Topping', ['nombre', 'precio']); } catch (e) { renderizarLista([], 'Topping', ['nombre', 'precio']); } }
      async function cargarJarabes() { try { const data = await fetchAPI('/api/jarabes'); renderizarLista(data, 'Jarabe', ['nombre', 'precio']); } catch (e) { renderizarLista([], 'Jarabe', ['nombre', 'precio']); } }
      async function cargarClientes() { try { const data = await fetchAPI('/api/clientes'); renderizarLista(data, 'Cliente', ['nombre', 'telefono']); } catch (e) { renderizarLista([], 'Cliente', ['nombre', 'telefono']); } }
      async function cargarOpcionesParaVenta() { 
          await Promise.all([ cargarProductosParaVenta(), cargarToppingsParaVenta(), cargarJarabesParaVenta(), cargarClientesParaVenta() ]);
          setupCollapsibles(); // Llamar aquí para asegurarse de que los botones existan
      }
      
      async function cargarDataParaSelector(url, selectId, valueField, textField) {
        try {
          const data = await fetchAPI(url);
          const select = document.getElementById(selectId);
          const currentValue = select.value;
          let optionsHtml = selectId === 'ventaCliente' ? '<option value="">Público General</option>' : '<option value="">-- Selecciona un producto --</option>';
          data.forEach(item => {
            let text = typeof textField === 'function' ? textField(item) : item[textField];
            optionsHtml += `<option value="${item[valueField]}" data-precio="${item.precio || 0}">${text}</option>`;
          });
          select.innerHTML = optionsHtml;
          select.value = currentValue;
        } catch(e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarDataParaBotones(url, containerId) {
          try{
              const data = await fetchAPI(url);
              const container = document.getElementById(containerId);
              container.innerHTML = '';
              data.forEach(item => {
                  const button = document.createElement('button');
                  button.className = 'option-btn';
                  button.textContent = `${item.nombre} - $${item.precio.toFixed(2)}`;
                  button.dataset.id = item.id;
                  button.dataset.precio = item.precio;
                  button.dataset.nombre = item.nombre;
                  button.onclick = () => {
                      button.classList.toggle('selected');
                      calcularTotalEnForm();
                  };
                  container.appendChild(button);
              });
          } catch(e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarProductosParaVenta() { await cargarDataParaSelector('/api/productos', 'ventaProducto', 'id', item => `${item.nombre} - $${item.precio.toFixed(2)}`); }
      async function cargarClientesParaVenta() { await cargarDataParaSelector('/api/clientes', 'ventaCliente', 'id', 'nombre'); }
      async function cargarToppingsParaVenta() { await cargarDataParaBotones('/api/toppings', 'toppings-container'); }
      async function cargarJarabesParaVenta() { await cargarDataParaBotones('/api/jarabes', 'jarabes-container'); }
      
      function calcularTotalEnForm() {
        let totalItemFormulario = 0;
        const productoSelect = document.getElementById('ventaProducto');
        if (productoSelect.value) {
            const precioProducto = parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.precio);
            const cantidad = parseInt(document.getElementById('ventaCantidad').value) || 1;
            totalItemFormulario += precioProducto * cantidad;
        }
        document.querySelectorAll('.option-btn.selected').forEach(btn => { totalItemFormulario += parseFloat(btn.dataset.precio); });
        actualizarTotalVenta(totalItemFormulario);
      }
      
      function resetearFormularioItem() {
          document.getElementById('ventaProducto').value = '';
          document.getElementById('ventaCantidad').value = '1';
          document.getElementById('ventaNota').value = '';
          document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
          document.querySelectorAll(".collapsible.active").forEach(c => {
              c.classList.remove('active');
              c.nextElementSibling.style.maxHeight = '0px';
          });
          calcularTotalEnForm();
      }

      function agregarAVenta() {
        const productoSelect = document.getElementById('ventaProducto');
        if (!productoSelect.value) { alert('Selecciona un producto'); return; }
        const productoNombre = productoSelect.options[productoSelect.selectedIndex].text.split(' - ')[0];
        const cantidad = parseInt(document.getElementById('ventaCantidad').value) || 1;
        const toppings = Array.from(document.querySelectorAll('#toppings-container .option-btn.selected')).map(btn => ({ nombre: btn.dataset.nombre }));
        const jarabes = Array.from(document.querySelectorAll('#jarabes-container .option-btn.selected')).map(btn => ({ nombre: btn.dataset.nombre }));
        const nota = document.getElementById('ventaNota').value.trim();
        let totalItem = (parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.precio) * cantidad) + 
                        Array.from(document.querySelectorAll('.option-btn.selected')).reduce((acc, btn) => acc + parseFloat(btn.dataset.precio), 0);
        ventaActual.push({ productoNombre, cantidad, toppings, jarabes, nota, total: totalItem });
        mostrarVentaActual();
        resetearFormularioItem();
      }

      async function registrarVenta() {
        if (ventaActual.length === 0) { alert('Agrega al menos un producto a la venta'); return; }
        const clienteSelect = document.getElementById('ventaCliente');
        const costoDomicilio = document.getElementById('checkDomicilio').checked ? parseFloat(document.getElementById('costoDomicilio').value || 0) : 0;
        const subtotal = ventaActual.reduce((a, i) => a + i.total, 0);
        const ventaCompleta = { 
          id: Date.now(), fecha: new Date().toISOString(), clienteId: clienteSelect.value ? parseInt(clienteSelect.value) : null,
          clienteNombre: clienteSelect.value ? clienteSelect.options[clienteSelect.selectedIndex].text : 'Público General',
          items: ventaActual, subtotal: subtotal, costoDomicilio: costoDomicilio, total: subtotal + costoDomicilio,
          metodoPago: document.getElementById('metodoPago').value
        };
        try {
          const ventaGuardada = await fetchAPI('/api/ventas', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(ventaCompleta) });
          alert('Venta registrada con éxito');
          document.getElementById('ticket').textContent = generarTextoTicket(ventaGuardada);
          resetearFormularioCompleto();
        } catch(e) { alert(`Error: ${e.message}`); }
      }

      function mostrarVentaActual() {
        const lista = document.getElementById('listaVentaActual');
        lista.innerHTML = '';
        ventaActual.forEach((item, index) => {
          const li = document.createElement('li');
          const itemInfo = document.createElement('div');
          itemInfo.className = 'item-info';
          itemInfo.innerHTML = `<span>${item.productoNombre} x${item.cantidad} - $${item.total.toFixed(2)}</span>`;
          const btnEliminar = document.createElement('button');
          btnEliminar.textContent = 'X';
          btnEliminar.className = 'btn-eliminar-item';
          btnEliminar.onclick = () => { ventaActual.splice(index, 1); mostrarVentaActual(); };
          itemInfo.appendChild(btnEliminar);
          li.appendChild(itemInfo);
          if (item.nota) {
            const notaDiv = document.createElement('div');
            notaDiv.className = 'item-nota';
            notaDiv.textContent = `Nota: ${item.nota}`;
            li.appendChild(notaDiv);
          }
          lista.appendChild(li);
        });
        actualizarTotalVenta();
      }

      function actualizarTotalVenta(totalFormulario = 0) {
        const subtotalVenta = ventaActual.reduce((acc, item) => acc + item.total, 0);
        const costoDomicilio = document.getElementById('checkDomicilio').checked ? parseFloat(document.getElementById('costoDomicilio').value || 0) : 0;
        const totalFinal = subtotalVenta + totalFormulario + costoDomicilio;
        document.getElementById('totalVenta').textContent = `Total Venta: $${totalFinal.toFixed(2)}`;
      }

      function resetearFormularioCompleto() {
        ventaActual = [];
        document.getElementById('listaVentaActual').innerHTML = '';
        document.getElementById('formVenta').reset();
        document.getElementById('checkDomicilio').checked = false;
        document.getElementById('costoDomicilio').style.display = 'none';
        document.querySelectorAll('.option-btn.selected').forEach(btn => btn.classList.remove('selected'));
        document.querySelectorAll(".collapsible.active").forEach(c => {
            c.classList.remove('active');
            c.nextElementSibling.style.maxHeight = '0px';
        });
        document.getElementById('metodoPago').value = "Efectivo";
        actualizarTotalVenta();
      }

      function generarTextoTicket(venta) {
        let texto = `--- Ticket Dulces Amigas ---\nFecha: ${new Date(venta.fecha).toLocaleString()}\nCliente: ${venta.clienteNombre}\nAtendido por: ${venta.vendedorUsername}\n\n`;
        venta.items.forEach((n, a) => {
          texto += `${a + 1}. ${n.productoNombre} x${n.cantidad}\n`;
          if (n.toppings && n.toppings.length) texto += `   + Toppings: ${n.toppings.map(e => e.nombre).join(", ")}\n`;
          if (n.jarabes && n.jarabes.length) texto += `   + Jarabes: ${n.jarabes.map(e => e.nombre).join(", ")}\n`;
          if (n.nota) texto += `   * Nota: ${n.nota}\n`;
          texto += `   Subtotal Item: $${n.total.toFixed(2)}\n\n`;
        });
        texto += `---------------------------\nSubtotal: $${venta.subtotal.toFixed(2)}\n`;
        if (venta.costoDomicilio > 0) texto += `Domicilio: $${venta.costoDomicilio.toFixed(2)}\n`;
        texto += `TOTAL: $${venta.total.toFixed(2)}\n`;
        texto += `Método de pago: ${venta.metodoPago}\n---------------------------\n¡Gracias por tu compra!`;
        return texto;
      }
      
      async function cargarUsuarios() {
          try {
              const usuarios = await fetchAPI('/api/usuarios');
              const lista = document.getElementById('listaUsuarios');
              if(!lista) return;
              lista.innerHTML = '';
              usuarios.forEach(user => {
                  const li = document.createElement('li');
                  const texto = document.createElement('span');
                  texto.textContent = `${user.username} - Rol: ${user.role}`;
                  const divBotones = document.createElement('div');
                  const btnCambiarPass = document.createElement('button');
                  btnCambiarPass.textContent = 'Cambiar Contraseña';
                  btnCambiarPass.onclick = () => cambiarPasswordUsuario(user.id, user.username);
                  const btnEliminar = document.createElement('button');
                  btnEliminar.textContent = 'Eliminar';
                  btnEliminar.className = 'btn-eliminar-item';
                  if (user.id === 1) { btnEliminar.disabled = true; btnEliminar.title = "No se puede eliminar al admin principal"; }
                  btnEliminar.onclick = () => eliminarUsuario(user.id);
                  divBotones.appendChild(btnCambiarPass);
                  divBotones.appendChild(btnEliminar);
                  li.appendChild(texto);
                  li.appendChild(divBotones);
                  lista.appendChild(li);
              });
          } catch (e) { /* Error manejado en fetchAPI */ }
      }

      async function crearUsuario(e) {
          e.preventDefault();
          const form = e.target;
          const username = document.getElementById('usernameUsuario').value;
          const password = document.getElementById('passwordUsuario').value;
          const role = document.getElementById('roleUsuario').value;
          try {
              await fetchAPI('/api/usuarios', { method: 'POST', body: JSON.stringify({ username, password, role }) });
              form.reset();
              await cargarUsuarios();
          } catch (error) { alert(`Error: ${error.message}`); }
      }
      
      async function cambiarPasswordUsuario(id, username) {
          const nuevaPassword = prompt(`Introduce la NUEVA contraseña para el usuario "${username}":`);
          if (nuevaPassword && nuevaPassword.trim() !== '') {
              try {
                  await fetchAPI(`/api/usuarios/${id}`, { method: 'PUT', body: JSON.stringify({ password: nuevaPassword }) });
                  alert('Contraseña actualizada con éxito.');
              } catch (error) { alert(`Error: ${error.message}`); }
          }
      }

      async function eliminarUsuario(id) {
          if (confirm('¿Estás seguro de que quieres eliminar a este usuario?')) {
              try {
                  await fetchAPI(`/api/usuarios/${id}`, { method: 'DELETE' });
                  await cargarUsuarios();
              } catch (error) { alert(`Error: ${error.message}`); }
          }
      }

      async function cargarVentasHistorial() {
        try {
          let todasLasVentas = await fetchAPI('/api/ventas');
          const periodo = document.querySelector('#botones-periodo button.active').dataset.periodo;
          const clienteId = document.getElementById('filtroCliente').value;
          const usuarioId = document.getElementById('filtroUsuario').value;
          const ahora = new Date();
          let fechaInicio;
          if (periodo === 'mes') { fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1); }
          else if (periodo === 'semana') { fechaInicio = new Date(ahora); fechaInicio.setDate(ahora.getDate() - ahora.getDay() + (ahora.getDay() === 0 ? -6 : 1)); }
          else { fechaInicio = new Date(ahora); }
          fechaInicio.setHours(0, 0, 0, 0);
          let ventasFiltradas = todasLasVentas.filter(venta => new Date(venta.fecha) >= fechaInicio);
          if (clienteId) { ventasFiltradas = ventasFiltradas.filter(venta => venta.clienteId == clienteId); }
          if (usuarioId) { ventasFiltradas = ventasFiltradas.filter(venta => venta.vendedorId == usuarioId); }
          const tbody = document.getElementById('tablaVentasBody');
          tbody.innerHTML = '';
          ventasFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(venta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${venta.id}</td><td>${venta.vendedorUsername}</td><td>${venta.clienteNombre}</td><td>$${venta.total.toFixed(2)}</td><td>${new Date(venta.fecha).toLocaleString()}</td><td><button class="btn-eliminar-venta" data-id="${venta.id}">X</button></td>`;
            tbody.appendChild(tr);
          });
          const totalPeriodo = ventasFiltradas.reduce((acc, venta) => acc + venta.total, 0);
          document.getElementById('totalPeriodoHistorial').textContent = `Total del Período Filtrado: $${totalPeriodo.toFixed(2)}`;
          prepararDatosParaGraficas(ventasFiltradas);
          generarResumen(ventasFiltradas);
          document.querySelectorAll('.btn-eliminar-venta').forEach(btn => btn.addEventListener('click', () => eliminarVenta(btn.dataset.id)));
        } catch (e) { /* Error manejado en fetchAPI */ }
      }
      
      async function cargarUsuariosParaFiltro() {
        try {
          const data = await fetchAPI('/api/usuarios');
          const select = document.getElementById('filtroUsuario');
          select.innerHTML = '<option value="">Todos los Vendedores</option>';
          data.forEach(user => select.innerHTML += `<option value="${user.id}">${user.username}</option>`);
        } catch (e) { /* Error manejado en fetchAPI */ }
      }

      async function cargarClientesParaFiltro() {
        try {
          const data = await fetchAPI('/api/clientes');
          const select = document.getElementById('filtroCliente');
          select.innerHTML = '<option value="">Todos los Clientes</option>';
          data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`);
        } catch (e) { /* Error manejado en fetchAPI */ }
      }
      
      async function eliminarVenta(id) {
        if (confirm('¿Deseas eliminar esta venta completa?')) {
          await fetchAPI(`/api/ventas/${id}`, { method: 'DELETE' });
          cargarVentasHistorial();
        }
      }

      function prepararDatosParaGraficas(ventas) {
        const formatoFecha = { weekday: 'short', day: 'numeric' };
        let ventasPorDia = {};
        ventas.forEach(venta => {
          const clave = new Date(venta.fecha).toLocaleDateString('es-ES', formatoFecha);
          ventasPorDia[clave] = (ventasPorDia[clave] || 0) + venta.total;
        });
        actualizarGraficaBarras(Object.keys(ventasPorDia), Object.values(ventasPorDia));
        let productosVendidos = {};
        ventas.forEach(venta => {
            venta.items.forEach(item => {
                productosVendidos[item.productoNombre] = (productosVendidos[item.productoNombre] || 0) + item.cantidad;
            });
        });
        actualizarGraficaCircular(Object.keys(productosVendidos), Object.values(productosVendidos));
      }

      function actualizarGraficaBarras(labels, data) {
        if (miGraficaDeVentas) { miGraficaDeVentas.destroy(); }
        const ctx = document.getElementById('graficaVentas')?.getContext('2d');
        if (!ctx) return;
        miGraficaDeVentas = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: `Ventas Totales`, data, backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
      }

      function actualizarGraficaCircular(labels, data) {
        if (miGraficaDeProductos) { miGraficaDeProductos.destroy(); }
        const ctx = document.getElementById('graficaProductos')?.getContext('2d');
        if (!ctx) return;
        miGraficaDeProductos = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ label: 'Productos Vendidos', data, backgroundColor: ['#4f46e5', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });
      }

      function generarResumen(ventas) {
          const resumenProductos = {}, resumenToppings = {}, resumenJarabes = {};
          ventas.forEach(venta => {
              venta.items.forEach(item => {
                  resumenProductos[item.productoNombre] = (resumenProductos[item.productoNombre] || 0) + item.cantidad;
                  item.toppings.forEach(t => { resumenToppings[t.nombre] = (resumenToppings[t.nombre] || 0) + 1; });
                  item.jarabes.forEach(j => { resumenJarabes[j.nombre] = (resumenJarabes[j.nombre] || 0) + 1; });
              });
          });
          let textoResumen = "--- RESUMEN DE PRODUCTOS ---\n" + Object.entries(resumenProductos).map(([n, c]) => `${n.padEnd(20, ' ')}: ${c}`).join('\n');
          textoResumen += "\n\n--- RESUMEN DE TOPPINGS ---\n" + Object.entries(resumenToppings).map(([n, c]) => `${n.padEnd(20, ' ')}: ${c}`).join('\n');
          textoResumen += "\n\n--- RESUMEN DE JARABES ---\n" + Object.entries(resumenJarabes).map(([n, c]) => `${n.padEnd(20, ' ')}: ${c}`).join('\n');
          document.getElementById('resumen-ventas').textContent = textoResumen;
      }
      
      function generarReportePDF() {
          const textoResumen = document.getElementById('resumen-ventas').textContent;
          const totalTexto = document.getElementById('totalPeriodoHistorial').textContent;
          const filtros = `Período: ${document.querySelector('#botones-periodo button.active').textContent}, Cliente: ${document.getElementById('filtroCliente').options[document.getElementById('filtroCliente').selectedIndex].text}, Vendedor: ${document.getElementById('filtroUsuario').options[document.getElementById('filtroUsuario').selectedIndex].text}`;
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF();
          pdf.setFontSize(18);
          pdf.setFont('helvetica', 'bold');
          pdf.text("Reporte de Ventas - Dulces Amigas", 105, 20, { align: 'center' });
          pdf.setFontSize(10);
          pdf.setFont('helvetica', 'normal');
          pdf.text(`Filtros Aplicados: ${filtros}`, 10, 35);
          pdf.text(`Fecha del Reporte: ${new Date().toLocaleString()}`, 10, 40);
          pdf.setFont('courier', 'normal');
          pdf.setFontSize(11);
          pdf.text(textoResumen, 10, 55);
          pdf.setFont('helvetica', 'bold');
          pdf.setFontSize(14);
          pdf.text(totalTexto, 105, 280, { align: 'center' });
          pdf.save("reporte-ventas.pdf");
      }

      function setupEventListeners() {
        document.querySelectorAll('nav a').forEach(b => b.addEventListener('click', (e) => {
            e.preventDefault();
            mostrarSeccion(b.dataset.seccion);
        }));
        document.getElementById('formProducto').addEventListener('submit', (e) => guardarItem(e, 'Producto'));
        document.getElementById('formTopping').addEventListener('submit', (e) => guardarItem(e, 'Topping'));
        document.getElementById('formJarabe').addEventListener('submit', (e) => guardarItem(e, 'Jarabe'));
        document.getElementById('formCliente').addEventListener('submit', (e) => guardarItem(e, 'Cliente'));
        document.getElementById('formUsuario').addEventListener('submit', crearUsuario);
        document.getElementById('btnAgregarVenta').addEventListener('click', agregarAVenta);
        document.getElementById('btnRegistrarVenta').addEventListener('click', registrarVenta);
        document.getElementById('ventaProducto').addEventListener('change', calcularTotalEnForm);
        document.getElementById('ventaCantidad').addEventListener('input', calcularTotalEnForm);
        document.getElementById('checkDomicilio').addEventListener('change', (e) => {
          const costoInput = document.getElementById('costoDomicilio');
          costoInput.style.display = e.target.checked ? 'inline-block' : 'none';
          if (e.target.checked) { costoInput.value = COSTO_DOMICILIO_PREDET.toFixed(2); }
          else { costoInput.value = ''; }
          calcularTotalEnForm();
        });
        document.getElementById('costoDomicilio').addEventListener('input', calcularTotalEnForm);
        document.querySelectorAll('#botones-periodo button').forEach(button => {
          button.addEventListener('click', () => {
            document.querySelector('#botones-periodo button.active').classList.remove('active');
            button.classList.add('active');
            cargarVentasHistorial();
          });
        });
        document.getElementById('filtroCliente').addEventListener('change', cargarVentasHistorial);
        document.getElementById('filtroUsuario').addEventListener('change', cargarVentasHistorial);
        document.getElementById('btnGenerarReporte').addEventListener('click', generarReportePDF);
        document.getElementById('btnGenerarPDF').addEventListener('click', () => {
          const ticketElement = document.getElementById('ticket');
          if (ticketElement.textContent.trim() === '') { alert('Primero debe registrar una venta para generar un ticket.'); return; }
          html2canvas(ticketElement).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF();
            const imgProps= pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save("ticket-dulces-amigas.pdf");
          });
        });
        document.getElementById('btnEnviarWhatsapp').addEventListener('click', () => {
          const textoTicket = document.getElementById('ticket').textContent;
          if (textoTicket.trim() === '') { alert('No hay un ticket generado para enviar.'); return; }
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(textoTicket)}`, '_blank');
        });
      }

      if (localStorage.getItem('token')) {
        showApp();
      } else {
        showLogin();
      }
    });
  </script>
</body>
</html>